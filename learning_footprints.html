<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¿°å­¸ãƒ»å­¸ç¿’è¶³è·¡ V22.5 (æ™ºèƒ½å»é‡ç‰ˆ)</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* åŸºç¤è¨­å®š */
        * { box-sizing: border-box; }
        body { 
            margin: 0; padding: 0; 
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; 
            background: #f8fafc; 
            height: 100vh; 
            display: flex; 
            overflow: hidden; 
        }
        :root { 
            --math: #3b82f6; --math-bg: #eff6ff; 
            --nature: #10b981; --nature-bg: #ecfdf5;
            --dark: #1e293b; --gray: #64748b;
            --fp-color: #0369a1; --fp-bg: #e0f2fe; --fp-border: #bae6fd;
        }

        /* === å´é‚Šæ¬„ (åå–®) === */
        .sidebar { 
            width: 280px; 
            background: white; 
            border-right: 1px solid #e2e8f0; 
            display: flex; flex-direction: column; 
            z-index: 10; 
            flex-shrink: 0; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }
        .sb-header { padding: 15px; background: var(--dark); color: white; font-weight: bold; display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .sb-search { padding: 10px; border-bottom: 1px solid #e2e8f0; background: #f1f5f9; flex-shrink: 0; }
        .search-input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none; }
        .search-input:focus { border-color: var(--math); }
        
        .student-list { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px; 
            padding-bottom: 80px;
            scroll-behavior: smooth;
        }
        
        .stu-item { 
            padding: 12px 15px; margin-bottom: 8px; 
            background: white; border: 1px solid #e2e8f0; border-radius: 8px; 
            cursor: pointer; transition: all 0.2s ease; 
            display: flex; justify-content: space-between; align-items: center; 
            flex-shrink: 0; 
            min-height: 54px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        .stu-item:hover { transform: translateX(3px); border-color: var(--math); background: #f0f9ff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stu-item.active { background: var(--dark); color: white; border-color: var(--dark); transform: scale(1.02); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .stu-name { font-weight: bold; font-size: 1rem; }
        .stu-tag { font-size: 0.8rem; background: #f1f5f9; color: #64748b; padding: 2px 8px; border-radius: 12px; }
        .stu-item.active .stu-tag { background: rgba(255,255,255,0.2); color: #cbd5e1; }

        /* === ä¸»ç•«é¢ === */
        .main { 
            flex: 1; 
            display: flex; flex-direction: column; 
            position: relative; 
            overflow: hidden; 
            background: #f1f5f9; 
            min-width: 0; 
        }
        
        .top-info { 
            height: 65px; 
            background: white; border-bottom: 1px solid #e2e8f0; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 25px; 
            flex-shrink: 0; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            z-index: 5; 
        }
        .student-meta { font-size: 1.3rem; font-weight: 800; color: var(--dark); display: flex; align-items: center; gap: 15px; }
        .meta-stat { font-size: 0.9rem; font-weight: normal; color: var(--gray); background: #f1f5f9; padding: 5px 15px; border-radius: 20px; border: 1px solid #e2e8f0; }
        
        .subject-switch { display: flex; background: #e2e8f0; padding: 4px; border-radius: 8px; }
        .switch-btn { padding: 6px 18px; border-radius: 6px; cursor: pointer; font-weight: bold; color: var(--gray); border: none; background: transparent; transition: 0.2s; font-size: 0.95rem; }
        .switch-btn.active { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .switch-btn.active.math { color: var(--math); }
        .switch-btn.active.nature { color: var(--nature); }

        .map-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 25px; 
            display: flex; flex-direction: column; 
            gap: 25px; 
            min-height: 0; 
        }
        
        .empty-state { text-align: center; color: #94a3b8; margin-top: 80px; font-size: 1.2rem; display: flex; flex-direction: column; align-items: center; gap: 10px; }

        .chapter-block { 
            background: white; border-radius: 12px; border: 1px solid #e2e8f0; 
            overflow: hidden; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); 
            transition: 0.3s;
            flex-shrink: 0; 
        }
        .chapter-block:hover { box-shadow: 0 10px 15px rgba(0,0,0,0.05); }
        
        .chapter-header { padding: 12px 20px; background: linear-gradient(to right, #f8fafc, #fff); border-bottom: 1px solid #e2e8f0; font-weight: 800; color: #334155; display: flex; justify-content: space-between; cursor:pointer; user-select: none; font-size: 1.05rem; }
        .chapter-header:hover { background: #f1f5f9; color: var(--math); }
        
        .topic-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 1px; 
            background: #e2e8f0; 
            border-top: 1px solid #e2e8f0; 
        }
        
        /* å–®ä¸€ä¸»é¡Œå¡ç‰‡ */
        .topic-card { 
            background: white; padding: 18px; 
            display: flex; flex-direction: column; gap: 10px; 
            position: relative; cursor: pointer; transition: 0.2s; 
        }
        .topic-card:hover { background: #fffbeb; z-index: 2; transform: scale(1.005); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        .status-bar { position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background: var(--math); }
        .nature .status-bar { background: var(--nature); }

        .tc-header-row { display: flex; justify-content: space-between; align-items: flex-start; padding-left: 10px; }
        .tc-title { font-weight: bold; color: #334155; font-size: 1.05rem; line-height: 1.4; flex: 1; }
        .tc-expand-icon { font-size: 0.9rem; color: #94a3b8; margin-left: 10px; transition: 0.3s; }
        .topic-card.open .tc-expand-icon { transform: rotate(180deg); color: var(--math); }

        .tc-meta { padding-left: 10px; font-size: 0.85rem; color: #64748b; display: flex; gap: 10px; }
        
        .tc-action { display: flex; justify-content: flex-end; margin-top: auto; padding-top: 10px; border-top: 1px dashed #f1f5f9; }
        .assign-btn { 
            padding: 8px 16px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; 
            font-size: 0.9rem; font-weight: bold; color: #475569; cursor: pointer; transition: 0.2s; 
            display: flex; align-items: center; gap: 6px; 
        }
        .assign-btn:hover { background: var(--math); color: white; border-color: var(--math); box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
        .assign-btn.nature-btn:hover { background: var(--nature); border-color: var(--nature); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }

        /* è©³ç´°è³‡æ–™å±•é–‹å€ */
        .topic-details { 
            display: none; 
            margin-top: 5px; padding: 10px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;
            font-size: 0.9rem; color: #64748b; animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .topic-card.open .topic-details { display: block; }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .detail-block { border-bottom: 1px dashed #cbd5e1; padding-bottom: 10px; margin-bottom: 10px; }
        .detail-block:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        
        .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .d-date { font-weight: bold; color: #334155; display:flex; align-items:center; gap:5px; }

        /* è¶³è·¡ (çŸ¥è­˜é») è† å›Šæ¨£å¼ */
        .footprint-list { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
        .fp-badge { 
            font-size: 0.8rem; background: var(--fp-bg); color: var(--fp-color); padding: 4px 10px; border-radius: 6px; 
            font-family: Consolas, "Microsoft JhengHei", monospace; border: 1px solid var(--fp-border); 
            display: inline-flex; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .fp-badge:hover { background: #bae6fd; transform: translateY(-1px); }
        .fp-badge i { margin-right: 5px; font-size: 0.8em; opacity: 0.6; }

        /* å½ˆçª—æ¨£å¼ */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal { background: white; padding: 30px; border-radius: 16px; width: 420px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); transform-origin: center; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .qr-box { margin: 20px auto; padding: 15px; background: white; border: 2px solid #e2e8f0; border-radius: 12px; display: inline-block; }
        .modal-title { font-size: 1.4rem; font-weight: 800; color: var(--dark); margin-bottom: 8px; }
        .modal-sub { color: var(--gray); font-size: 1rem; margin-bottom: 20px; }
        .close-btn { margin-top: 20px; padding: 10px 25px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px; cursor: pointer; font-weight: bold; color: #475569; transition: 0.2s; }
        .close-btn:hover { background: #e2e8f0; color: var(--dark); }

        .loading-mask { position: fixed; inset: 0; background: white; z-index: 300; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        /* æ»¾å‹•æ¢ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>

    <div id="loading-mask" class="loading-mask">
        <i class="fas fa-satellite-dish fa-spin" style="font-size: 3rem; color: var(--math); margin-bottom: 20px;"></i>
        <h2 style="color: var(--dark); font-weight:800;">å­¸ç¿’è¶³è·¡è³‡æ–™åº«åŒæ­¥ä¸­...</h2>
        <div id="loading-text" style="color: var(--gray);">æ­£åœ¨è¼‰å…¥ V22.5 æ™ºèƒ½å»é‡ç‰ˆ...</div>
    </div>

    <div class="sidebar">
        <div class="sb-header">
            <i class="fas fa-map-marked-alt"></i> å­¸ç¿’è¶³è·¡ç³»çµ±
        </div>
        <div class="sb-search">
            <input type="text" class="search-input" placeholder="ğŸ” æœå°‹å­¸ç”Ÿå§“åæˆ–å¸³è™Ÿ..." onkeyup="filterStudents(this.value)">
        </div>
        <div id="student-list" class="student-list"></div>
    </div>

    <div class="main">
        <div class="top-info">
            <div class="student-meta">
                <span id="current-stu-name"><i class="fas fa-user-graduate"></i> è«‹å…ˆé¸æ“‡ä¸€ä½å­¸ç”Ÿ</span>
                <span id="stu-total-topics" class="meta-stat" style="display:none;">å·²å­¸ç¿’ 0 å€‹å–®å…ƒ</span>
            </div>
            <div class="subject-switch">
                <button class="switch-btn active math" onclick="setSubject('math')">æ•¸å­¸</button>
                <button class="switch-btn" onclick="setSubject('nature')">è‡ªç„¶</button>
            </div>
        </div>

        <div id="map-container" class="map-container">
            <div class="empty-state">
                <i class="fas fa-shoe-prints" style="font-size: 3rem; color: #cbd5e1;"></i>
                <p>è«‹å¾å·¦å´åå–®é¸æ“‡ä¸€ä½å­¸ç”Ÿ<br>ä»¥æŸ¥çœ‹è©³ç´°å­¸ç¿’è¶³è·¡</p>
            </div>
        </div>
    </div>

    <div id="assign-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title"><i class="fas fa-rocket"></i> ä»»å‹™æ´¾ä»»ç¢ºèª</div>
            <div class="modal-sub" id="modal-topic-name"></div>
            <div id="qrcode" class="qr-box"></div>
            <div>
                <a id="mission-link" href="#" target="_blank" style="display:block; color:var(--math); font-weight:bold; margin-bottom:10px; text-decoration:none; padding:10px; background:#eff6ff; border-radius:6px;">é–‹å•Ÿä»»å‹™é€£çµ â†—</a>
                <button class="close-btn" onclick="closeModal()">é—œé–‰è¦–çª—</button>
            </div>
        </div>
    </div>

<script>
    const DATA_SOURCE_MATH = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR95YiWV-IcQ80_369MccfAROg6mu-kwJjy9v3X92Lb8vKORpw_9wmPJj1-Xeii14iChPznFEaO5OU6/pub?gid=423591624&single=true&output=csv';
    const DATA_SOURCE_NATURE = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR95YiWV-IcQ80_369MccfAROg6mu-kwJjy9v3X92Lb8vKORpw_9wmPJj1-Xeii14iChPznFEaO5OU6/pub?gid=685359916&single=true&output=csv';

    let dbMath = [], dbNature = []; 
    let students = new Map(); 
    let currentSubject = 'math';
    let currentStudentId = null;

    // åˆå§‹åŒ–
    window.onload = async () => {
        try {
            await Promise.all([fetchData(DATA_SOURCE_MATH, 'math'), fetchData(DATA_SOURCE_NATURE, 'nature')]);
            renderStudentList();
            document.getElementById('loading-mask').style.display = 'none';
        } catch(e) {
            alert("æ•¸æ“šè®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š: " + e.message);
            document.getElementById('loading-text').innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹é‡æ•´é é¢";
        }
    };

    // æŠ“å–è³‡æ–™
    function fetchData(url, type) {
        return new Promise((resolve) => {
            Papa.parse(url + '&t=' + Date.now(), {
                download: true, header: false, skipEmptyLines: true,
                complete: (r) => {
                    let records = [];
                    for(let i=1; i<r.data.length; i++) {
                        let row = r.data[i];
                        let time = row[0];
                        let col1 = (row[1]||'').trim();
                        let col2 = (row[2]||'').trim();
                        let id = col1, name = col2;
                        
                        let hasChinese1 = /[\u4e00-\u9fa5]/.test(col1);
                        let hasChinese2 = /[\u4e00-\u9fa5]/.test(col2);
                        if (hasChinese1 && !hasChinese2) { name = col1; id = col2; }
                        else if (!hasChinese1 && hasChinese2) { id = col1; name = col2; }
                        else { if(!name) name = col1; }

                        if(!name) continue;

                        let key = id || name;
                        if(!students.has(key)) students.set(key, {id: id || 'ç„¡å¸³è™Ÿ', name: name});

                        let score = -1;
                        if(row[7]) {
                            let cleanScore = row[7].toString().replace('%','').trim();
                            if(!isNaN(parseInt(cleanScore))) score = parseInt(cleanScore);
                        }

                        // è®€å– Column J - å­¸ç¿’è¶³è·¡
                        let footprint = (row[9] || "").trim();

                        // é—œéµç¯©é¸ï¼šç„¡è¶³è·¡å‰‡å¿½ç•¥
                        if (!footprint || footprint === "[]" || footprint === "") continue;

                        records.push({
                            time: time,
                            name: name,
                            id: id || name,
                            topic: (row[3]||'æœªåˆ†é¡å–®å…ƒ').trim(),
                            footprint: footprint 
                        });
                    }
                    if(type === 'math') dbMath = records; else dbNature = records;
                    resolve();
                }
            });
        });
    }

    // æ¸²æŸ“å´é‚Šå­¸ç”Ÿåˆ—è¡¨
    function renderStudentList() {
        const list = document.getElementById('student-list');
        list.innerHTML = '';
        let sorted = Array.from(students.values()).sort((a,b) => (a.id || '').localeCompare(b.id || '', undefined, {numeric:true}));
        sorted.forEach(stu => {
            let div = document.createElement('div');
            div.className = 'stu-item';
            div.dataset.id = stu.id || stu.name;
            div.innerHTML = `<span class="stu-name">${stu.name}</span> <span class="stu-tag">${stu.id}</span>`;
            div.onclick = () => selectStudent(stu.id || stu.name);
            list.appendChild(div);
        });
    }

    function filterStudents(val) {
        val = val.toLowerCase().trim();
        document.querySelectorAll('.stu-item').forEach(el => {
            el.style.display = el.innerText.toLowerCase().includes(val) ? 'flex' : 'none';
        });
    }

    function setSubject(sub) {
        currentSubject = sub;
        document.querySelectorAll('.switch-btn').forEach(b => b.classList.remove('active', 'math', 'nature'));
        document.querySelector(`.switch-btn[onclick*="${sub}"]`).classList.add('active', sub);
        if(currentStudentId) renderFootprints(currentStudentId);
    }

    function selectStudent(key) {
        currentStudentId = key;
        document.querySelectorAll('.stu-item').forEach(el => el.classList.remove('active'));
        let target = document.querySelector(`.stu-item[data-id="${key}"]`);
        if(target) { target.classList.add('active'); target.scrollIntoView({behavior: "smooth", block: "center"}); }
        let stu = students.get(key);
        if(stu) {
            document.getElementById('current-stu-name').innerHTML = `<i class="fas fa-user-graduate"></i> ${stu.name} <span style="font-size:0.8em; color:#94a3b8;">(${stu.id})</span>`;
            document.getElementById('stu-total-topics').style.display = 'inline-block';
            renderFootprints(key);
        }
    }

    // â˜… æ ¸å¿ƒï¼šæ¸²æŸ“æ™ºèƒ½å»é‡è¶³è·¡ (V22.5)
    function renderFootprints(key) {
        const container = document.getElementById('map-container');
        const stuData = students.get(key);
        if(!stuData) return;

        const rawData = currentSubject === 'math' ? dbMath : dbNature;
        let myRecords = rawData.filter(r => r.id === stuData.id || r.name === stuData.name);
        
        let topicMap = new Map();
        myRecords.forEach(r => {
            if(!topicMap.has(r.topic)) topicMap.set(r.topic, []);
            topicMap.get(r.topic).push(r);
        });

        let sortedTopics = Array.from(topicMap.keys()).sort((a,b) => a.localeCompare(b, undefined, {numeric:true}));

        if(sortedTopics.length === 0) {
            container.innerHTML = `<div class="empty-state"><i class="fas fa-wind" style="font-size:3rem; color:#e2e8f0; margin-bottom:10px;"></i>å°šç„¡${currentSubject==='math'?'æ•¸å­¸':'è‡ªç„¶'}å­¸ç¿’è¶³è·¡</div>`;
            updateStats(0);
            return;
        }

        container.innerHTML = '';
        let chapters = new Map();
        
        sortedTopics.forEach(topic => {
            let match = topic.match(/^(\d+(?:-\d+)?)/); 
            let chapKey = match ? match[1] : 'å…¶ä»–å–®å…ƒ';
            if(!match && topic.length > 0) chapKey = 'å°ˆé¡Œ/å…¶ä»–';
            if(!chapters.has(chapKey)) chapters.set(chapKey, []);
            chapters.get(chapKey).push(topic);
        });

        chapters.forEach((topics, chapKey) => {
            let chapDiv = document.createElement('div');
            chapDiv.className = 'chapter-block';
            
            let gridHtml = '';
            topics.forEach((topic, idx) => {
                let recs = topicMap.get(topic);
                // ä¾æ™‚é–“æ’åº (èˆŠ -> æ–°) ä»¥ä¾¿æ­£ç¢ºå»é‡
                recs.sort((a,b) => new Date(a.time) - new Date(b.time));
                
                // â˜… æ™ºèƒ½å»é‡æ ¸å¿ƒé‚è¼¯
                let topicSeenSet = new Set(); // æ¯å€‹å–®å…ƒç¨ç«‹çš„è¨˜æ†¶æ¸…å–®

                let detailHtml = recs.map(r => {
                    let tStr = r.time.split(' ')[0] || r.time;
                    
                    let fpHtml = '';
                    let hasNewContent = false; // æ¨™è¨˜æ­¤æ—¥æœŸæ˜¯å¦æœ‰æ–°æ±è¥¿

                    if (r.footprint) {
                        let cleanFp = r.footprint.split('http')[0].trim();
                        let parts = cleanFp.split(/[,>]/).map(s => s.trim()).filter(s => s);
                        
                        // éæ¿¾å·²è®€
                        let newParts = parts.filter(p => {
                            if (topicSeenSet.has(p)) return false; // å·²çœ‹éï¼Œéš±è—
                            topicSeenSet.add(p); // æ²’çœ‹éï¼ŒåŠ å…¥æ¸…å–®ä¸¦é¡¯ç¤º
                            return true;
                        });

                        if (newParts.length > 0) {
                            hasNewContent = true;
                            fpHtml = newParts.map(p => `<span class="fp-badge"><i class="fas fa-cube"></i> ${p}</span>`).join('');
                        }
                    }

                    // å¦‚æœå®Œå…¨æ²’æœ‰æ–°å…§å®¹ (å…¨éƒ½è¢«éæ¿¾æ‰äº†)ï¼Œå›å‚³ç©ºå­—ä¸² (ä¸é¡¯ç¤ºæ­¤åˆ—)
                    if (!hasNewContent) return '';

                    return `
                    <div class="detail-block">
                        <div class="detail-header">
                            <span class="d-date"><i class="far fa-clock"></i> ${tStr}</span>
                        </div>
                        <div class="footprint-list">
                            ${fpHtml}
                        </div>
                    </div>`;
                }).join('');

                // å¦‚æœå»é‡å¾Œé€£ä¸€è¡Œè³‡æ–™éƒ½æ²’æœ‰ï¼Œå°±ä¸é¡¯ç¤ºé€™å€‹å¡ç‰‡ (æˆ–é¡¯ç¤ºç„¡æ–°é€²åº¦)
                // é€™è£¡é¸æ“‡å¦‚æœæ²’è³‡æ–™é‚„æ˜¯é¡¯ç¤ºå¡ç‰‡ï¼Œä½†è£¡é¢ç©ºçš„ï¼Œè®“è€å¸«çŸ¥é“æœ‰åšéä½†æ²’æ–°æ±è¥¿
                // ç‚ºäº†ç¾è§€ï¼Œè‹¥ detailHtml ç‚ºç©ºï¼Œå¯ä»¥é¡¯ç¤ºæç¤º
                if (detailHtml === '') {
                    detailHtml = '<div style="color:#cbd5e1; padding:10px; font-size:0.85rem; text-align:center;">(æ­¤å–®å…ƒåƒ…é€²è¡Œé‡è¤‡ç·´ç¿’ï¼Œç„¡æ–°è¶³è·¡)</div>';
                }

                gridHtml += `
                    <div class="topic-card" onclick="toggleDetails(this)">
                        <div class="status-bar ${currentSubject==='nature'?'nature':''}"></div>
                        <div class="tc-header-row">
                            <div class="tc-title">${topic}</div>
                            <i class="fas fa-chevron-down tc-expand-icon"></i>
                        </div>
                        
                        <div class="tc-meta">
                            <span><i class="fas fa-history"></i> ç·´ç¿’ç´€éŒ„</span>
                        </div>
                        
                        <div class="topic-details">
                            ${detailHtml}
                        </div>

                        <div class="tc-action">
                            <button class="assign-btn ${currentSubject==='math'?'':'nature-btn'}" onclick="event.stopPropagation(); openAssignModal('${key}', '${topic}')">
                                <i class="fas fa-paper-plane"></i> æ´¾ä»»ä»»å‹™
                            </button>
                        </div>
                    </div>
                `;
            });

            let chapTitleDisplay = chapKey.includes('-') ? `ç« ç¯€ï¼š${chapKey}` : chapKey;
            
            chapDiv.innerHTML = `
                <div class="chapter-header" onclick="toggleChapterBody(this)">
                    <span><i class="fas fa-folder-open" style="margin-right:8px; color:var(--gray);"></i> ${chapTitleDisplay}</span>
                    <span style="font-size:0.9rem; color:#94a3b8;">${topics.length} å€‹ä¸»é¡Œ <i class="fas fa-caret-down"></i></span>
                </div>
                <div class="topic-grid">${gridHtml}</div>
            `;
            container.appendChild(chapDiv);
        });

        updateStats(sortedTopics.length);
    }

    function updateStats(total) {
        document.getElementById('stu-total-topics').innerText = `å·²å­¸ç¿’ ${total} å€‹å–®å…ƒ`;
    }

    function toggleDetails(card) {
        card.classList.toggle('open');
    }

    function toggleChapterBody(header) {
        let grid = header.nextElementSibling;
        let icon = header.querySelector('.fa-caret-down') || header.querySelector('.fa-caret-right');
        if(grid.style.display === 'none') {
            grid.style.display = 'grid';
            if(icon) icon.className = 'fas fa-caret-down';
        } else {
            grid.style.display = 'none';
            if(icon) icon.className = 'fas fa-caret-right';
        }
    }

    // Modal åŠŸèƒ½
    function openAssignModal(stuKey, topic) {
        let stu = students.get(stuKey);
        document.getElementById('modal-topic-name').innerText = `çµ¦ ${stu.name} çš„ä»»å‹™ï¼š${topic}`;
        document.getElementById('assign-modal').style.display = 'flex';
        
        let cleanTopic = topic.replace(/\s*\([^)]+\)$/, '').trim();
        let baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/')) + '/';
        const targetFile = (currentSubject === 'math') ? 'math.html' : 'nature.html';
        const fullUrl = `${baseUrl}${targetFile}?user=${encodeURIComponent(stu.id)}&topic=${encodeURIComponent(cleanTopic)}`;
        
        const qrBox = document.getElementById('qrcode');
        qrBox.innerHTML = '';
        new QRCode(qrBox, { text: fullUrl, width: 160, height: 160, colorDark: "#2d3436" });
        
        document.getElementById('mission-link').href = fullUrl;
    }

    function closeModal() {
        document.getElementById('assign-modal').style.display = 'none';
    }
    
    window.onclick = function(event) {
        if (event.target == document.getElementById('assign-modal')) {
            closeModal();
        }
    }
</script>

</body>
</html>