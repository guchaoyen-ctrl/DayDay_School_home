<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸å­¸æ•™å­¸ç³»çµ± (V7.71 - æ•¸æ“šå‚³é€ä¿®å¾©ç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #4361ee; --secondary-color: #4cc9f0; --accent-color: #f72585; 
            --success-color: #06d6a0; --warning-color: #ff9f1c; --bg-color: #f8f9fa; 
            --sidebar-bg: #ffffff; --text-main: #2b2d42; --column-width: 240px; --marquee-height: 32px;
        }
        * { box-sizing: border-box; }
        html, body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; margin: 0; padding: 0; background: var(--bg-color); color: var(--text-main); height: 100vh; overflow: hidden; }
        
        #expire-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center;
        }
        
        .app-marquee { position: absolute; top: 0; left: 0; width: 100%; height: var(--marquee-height); line-height: var(--marquee-height); background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); color: #fff; font-size: 0.9rem; font-weight: bold; overflow: hidden; z-index: 1002; }
        .app-marquee p { display: inline-block; margin: 0; padding-left: 100%; white-space: nowrap; animation: marquee-scroll 25s linear infinite; }
        @keyframes marquee-scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        
        .user-badge-fixed {
            position: fixed; top: 40px; right: 20px; z-index: 1001;
            background: rgba(255, 255, 255, 0.9); border: 1px solid #ddd;
            padding: 5px 15px; border-radius: 50px;
            font-size: 0.9rem; font-weight: bold; color: var(--primary-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: none; align-items: center; gap: 8px;
        }

        .app-layout { display: flex; height: 100vh; padding-top: var(--marquee-height); }
        .sidebar { width: var(--column-width); min-width: var(--column-width); background: var(--sidebar-bg); border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; height: 100%; z-index: 10; }
        .sidebar-header { padding: 15px; background: #fff; border-bottom: 1px solid #f0f0f0; }
        .sidebar-header h1 { font-size: 1.2rem; color: var(--primary-color); margin: 0; }
        .main-stepper { padding: 10px; flex: 1; overflow-y: auto; }
        .step-tab { padding: 10px 12px; margin-bottom: 5px; font-size: 0.9rem; font-weight: 600; color: #666; background: transparent; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .step-tab:hover { background: #f8f9fa; color: var(--primary-color); }
        .step-tab.active { background: rgba(67, 97, 238, 0.1); color: var(--primary-color); border-left: 3px solid var(--primary-color); }
        .step-tab.locked { cursor: not-allowed; opacity: 0.6; }
        .sidebar-footer { padding: 10px; border-top: 1px solid #eee; background: #fafafa; }
        .sidebar-btn { display: block; width: 100%; padding: 8px; margin-top: 5px; text-align: center; border-radius: 6px; text-decoration: none; font-weight: 600; transition: 0.2s; border: none; font-size: 0.9rem; cursor: pointer; color: #fff; }
        .btn-back { background: #6c757d; } .btn-meet { background: var(--success-color); } .btn-record { background: var(--secondary-color); }
        .main-content { flex: 1; display: flex; height: 100%; overflow: hidden; background: #e9ecef; position: relative; }
        .catalog-container { padding: 30px; width: 100%; max-width: 1400px; margin: 0 auto; overflow-y: auto; height: 100%; }
        .main-group-container { margin-bottom: 20px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
        .main-category-title { font-size: 1.4rem; color: #fff; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); padding: 15px 20px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s; }
        .main-category-title:hover { opacity: 0.95; }
        .toggle-arrow { transition: transform 0.3s ease; font-size: 1.2rem; }
        .main-category-title.active .toggle-arrow { transform: rotate(180deg); }
        .group-content { display: none; padding: 20px; background: #fdfdfd; animation: slideDown 0.3s ease-out; }
        .group-content.show { display: block; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .topic-section { margin-bottom: 20px; background: #fff; border-radius: 8px; padding: 15px; border: 1px solid #eee; border-left: 5px solid #ccc; }
        .main-group-m1 .topic-section { border-left-color: #4361ee; } .main-group-m2 .topic-section { border-left-color: #f72585; } .main-group-m3 .topic-section { border-left-color: #4cc9f0; } .main-group-m4 .topic-section { border-left-color: #06d6a0; } .main-group-others .topic-section { border-left-color: #6c757d; } .main-group-exam .topic-section { border-left-color: var(--warning-color); } 
        .section-header { font-size: 1.1rem; color: var(--text-main); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 10px; font-weight: 700; }
        .section-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .topic-card { background: #f8f9fa; padding: 12px 15px; border-radius: 8px; text-decoration: none; color: #444; display: flex; flex-direction: column; justify-content: center; min-height: 50px; border: 1px solid #eee; transition: all 0.2s; font-weight: 600; font-size: 0.95rem; }
        .topic-card:hover { background: #fff; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); color: var(--primary-color); border-color: var(--primary-color); }
        .media-pane { width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; padding: 20px; }
        .media-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .question-image { max-width: 100%; max-height: 100%; object-fit: contain; box-shadow: 0 5px 20px rgba(0,0,0,0.3); background: #fff; }
        iframe { width: 100%; height: 100%; border: none; }
        .control-pane { width: var(--column-width); min-width: var(--column-width); background: #fff; border-left: 1px solid #ddd; display: flex; flex-direction: column; padding: 15px; box-shadow: -5px 0 15px rgba(0,0,0,0.05); z-index: 5; overflow-y: auto; }
        .info-header { margin-bottom: 15px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        .info-title { font-size: 1rem; font-weight: bold; color: var(--primary-color); margin: 0 0 5px 0; line-height: 1.3; }
        .info-subtitle { font-size: 0.85rem; color: #888; }
        .sub-nav-tabs { display: flex; background: #f0f2f5; padding: 3px; border-radius: 8px; margin-bottom: 15px; }
        .sub-tab-button { flex: 1; padding: 6px; border-radius: 6px; border: none; background: transparent; color: #666; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
        .sub-tab-button.active { background: #fff; color: var(--primary-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .diff-group { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; }
        .diff-btn { flex: 1; min-width: 45%; padding: 6px; font-size: 0.8rem; border-radius: 6px; border: 1px solid #eee; background: #fff; cursor: pointer; color: #666; font-weight: 600; }
        .diff-btn.active { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        .diff-btn:disabled { opacity: 0.5; background: #f9f9f9; }
        .answer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .answer-btn { background: #fff; border: 2px solid #e9ecef; border-radius: 10px; height: 60px; font-size: 1.4rem; font-weight: 800; color: var(--text-main); cursor: pointer; transition: all 0.1s; display: flex; justify-content: center; align-items: center; }
        .answer-btn:hover:not(:disabled) { border-color: var(--primary-color); color: var(--primary-color); background: #f8f9fa; transform: translateY(-2px); }
        .control-footer { margin-top: auto; display: flex; flex-direction: column; gap: 8px; }
        .nav-row { display: flex; gap: 8px; }
        .nav-btn { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 0.95rem; color: #fff; display: flex; justify-content: center; align-items: center; gap: 5px; }
        .btn-prev { background: #6c757d; } .btn-next { background: var(--primary-color); } .btn-finish { background: var(--success-color); width: 100%; font-size: 1rem; padding: 12px; }
        .progress-bar-container { height: 6px; background: #eee; border-radius: 3px; margin-bottom: 15px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); width: 0%; transition: width 0.3s; }
        .feedback-text { text-align: center; font-size: 1.1rem; font-weight: bold; min-height: 25px; margin-bottom: 10px; }
        @media (max-width: 900px) { .app-layout { flex-direction: column; } .sidebar { display: none; } .main-content { flex-direction: column; } .media-pane { height: 50vh; padding: 10px; } .control-pane { width: 100%; height: 50vh; border-left: none; border-top: 1px solid #ddd; } .catalog-container { padding: 15px; } .user-badge-fixed { top: 5px; right: 5px; font-size: 0.8rem; padding: 3px 10px; background: rgba(255,255,255,0.8); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #login-overlay { background: rgba(240, 242, 245, 0.95); backdrop-filter: blur(5px); position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; display:flex; justify-content:center; align-items:center; }
        .login-container { background:#fff; padding:40px; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,0.1); text-align:center; width:350px; }
    </style>
</head>
<body>

    <div id="expire-overlay">
        <h1 style="color:#d63031; font-size:4rem; margin:0;">âŒ›</h1>
        <h2>ä»»å‹™é€£çµå·²éæœŸ</h2>
        <p>æ­¤æ´¾ä»»é€£çµå·²è¶…é 3 å°æ™‚æ™‚æ•ˆã€‚</p>
        <p>è«‹è¯ç¹«è€å¸«é‡æ–°æ´¾ä»»ã€‚</p>
    </div>

    <div id="user-badge" class="user-badge-fixed">
        <i class="fas fa-user-circle"></i> <span id="badge-name">--</span>
    </div>

    <div id="login-overlay">
        <div class="login-container">
            <h1 style="color:var(--primary-color); margin:0 0 10px 0;">æ•¸å­¸æ•™å­¸ç³»çµ±</h1>
            <p style="color: #888; margin-bottom:25px;">V7.71 æ•¸æ“šå‚³é€ä¿®å¾©ç‰ˆ</p>
            <input type="text" id="username" placeholder="å¸³è™Ÿ" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; margin-bottom:15px; box-sizing:border-box;">
            <input type="password" id="password" placeholder="å¯†ç¢¼" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; margin-bottom:20px; box-sizing:border-box;">
            <button id="btn-login" class="nav-btn btn-next" style="width:100%;" onclick="handleLogin()">ç™»å…¥ç³»çµ±</button>
            <div id="login-error" style="color:var(--accent-color); margin-top:15px;"></div>
        </div>
    </div>

    <div id="record-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center;">
        <div style="background:#fff; width:90%; max-width:800px; max-height:85vh; border-radius:12px; display:flex; flex-direction:column; overflow:hidden;">
            <div style="padding:15px 20px; background:var(--primary-color); color:#fff; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0; font-size:1.2rem; color:#fff;">ğŸ“‚ å­¸ç¿’æª”æ¡ˆ</h2>
                <span onclick="UserProgressManager.closeModal()" style="cursor:pointer; font-size:1.5rem;">Ã—</span>
            </div>
            <div style="padding:10px 20px; border-bottom:1px solid #eee; display:flex; gap:10px;">
                <button class="sub-tab-button active" onclick="UserProgressManager.renderList('error', this)">ğŸ“• éŒ¯é¡Œæœ¬</button>
                <button class="sub-tab-button" onclick="UserProgressManager.renderList('history', this)">ğŸ‘£ å­¸ç¿’è¶³è·¡</button>
                <button id="btn-modal-upload" class="sub-tab-button" style="background:var(--secondary-color); color:#fff; flex:none; margin-right:5px;" onclick="UserProgressManager.uploadToCloud('modal')"><i class="fas fa-robot"></i> è‡ªå‹•ä¸Šå‚³ä¸­</button>
                <button class="sub-tab-button" style="background:#eee; flex:none;" onclick="UserProgressManager.downloadHTML()">ğŸŒ ä¸‹è¼‰å‚™ä»½</button>
            </div>
            <div id="record-list-container" style="padding:20px; overflow-y:auto; flex:1; background:#f9f9f9;"></div>
        </div>
    </div>

    <div id="app-wrapper" style="display:none;">
        <div class="app-marquee"><p id="marquee-text">... è¼‰å…¥ä¸­ ...</p></div>
        <div id="app-content"></div>
    </div>

<script>
    (function checkExpiration() {
        const params = new URLSearchParams(window.location.search);
        const exp = params.get('exp');
        if (exp && Date.now() > parseInt(exp)) {
            document.getElementById('expire-overlay').style.display = 'flex';
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-wrapper').style.display = 'none';
            throw new Error("Link Expired");
        }
    })();

    const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbwDeWv1tAmP1X1VkJU_0BTCoKFPRLARvtgA4u-fint8Kq-w5LmkCC7wA_aO4RBvPOTO/exec"; 
    const CURRENT_SUBJECT = 'Math'; 
    const ALL_DATA_FILE = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSMZ6vXTQ39GZ2wr-Ce3zBOmc82mYofJDIR2Hp9nRQD5bn8vAuPtJCH-jMO4TXJb6aiZ9NVbmDmZLyF/pub?output=csv';
    const USER_LIST_FILE = './login.csv'; 
    const MARQUEE_FILE = 'è·‘é¦¬ç‡ˆæ–‡å­—.txt'; 
    const SECRET_KEY = "Yaohang2025Secure";

    const COL_KEY_TOPIC=0, COL_TEACH_CATEGORY=1, COL_TEACH_ID=2, COL_TEACH_IMG_URL=3, COL_TEACH_VIDEO_URL=5;
    const COL_QUIZ_TOPIC=6, COL_QUIZ_DIFFICULTY=7, COL_QUIZ_ID=8, COL_QUIZ_IMG_URL=9, COL_QUIZ_ANSWER=10, COL_QUIZ_VIDEO_URL=11, COL_QUIZ_SOURCE=12, COL_TOPIC_CATEGORY=13, COL_QUIZ_TYPE_MARKER=14, COL_EXAM_NAME=15, COL_EXAM_LINK=16; 
    const VALID_MCQ_ANSWERS = new Set(['A', 'B', 'C', 'D']);
    const PRACTICE_LEVELS_ORDER = ['å¿…ä¸Š', 'é¸B', 'é¸C'];
    const PROMOTION_THRESHOLD = 0.6;
    const QUIZ_BATCH_SIZE = 5;

    const app = document.getElementById('app-content');
    let validUsers = new Map(), unlockedMainSteps = new Set([1]), currentMainStep = 1, allLearningBlocks = [], quizLevels = { C: [], B: [], A: [] }, currentQuizLevel = 'C', currentQuizIndex = 0, currentQuizBatch = [], quizScores = { C: { correct: 0, total: 0 }, B: { correct: 0, total: 0 }, A: { correct: 0, total: 0 } };

    document.addEventListener('keydown', (e) => { if (document.getElementById('app-wrapper').style.display === 'none') return; if (document.getElementById('quiz-view-active')) { const key = e.key.toUpperCase(); const mapping = {'1':'A', '2':'B', '3':'C', '4':'D', 'A':'A', 'B':'B', 'C':'C', 'D':'D'}; if (mapping[key]) { const btns = document.querySelectorAll('.answer-btn'); const index = ['A','B','C','D'].indexOf(mapping[key]); if(btns[index] && !btns[index].disabled) checkQuizAns(mapping[key]); } if (e.key === 'Enter') { const nextBtn = document.getElementById('btn-quiz-next'); if (nextBtn && nextBtn.style.display !== 'none') nextBtn.click(); } } });

    const SoundFX = { ctx: null, init: () => { if (!SoundFX.ctx) { const AudioContext = window.AudioContext || window.webkitAudioContext; SoundFX.ctx = new AudioContext(); } if (SoundFX.ctx.state === 'suspended') SoundFX.ctx.resume(); }, playTone: (freq, type, duration, time, vol = 0.1) => { if (!SoundFX.ctx) return; const osc = SoundFX.ctx.createOscillator(); const gain = SoundFX.ctx.createGain(); osc.type = type; osc.frequency.setValueAtTime(freq, time); gain.gain.setValueAtTime(vol, time); gain.gain.exponentialRampToValueAtTime(0.001, time + duration); osc.connect(gain); gain.connect(SoundFX.ctx.destination); osc.start(time); osc.stop(time + duration); }, play: (effect) => { try { SoundFX.init(); const now = SoundFX.ctx.currentTime; if (effect === 'correct') { SoundFX.playTone(660, 'sine', 0.1, now, 0.1); SoundFX.playTone(880, 'sine', 0.4, now + 0.1, 0.1); } else if (effect === 'wrong') { SoundFX.playTone(150, 'sawtooth', 0.3, now, 0.15); SoundFX.playTone(120, 'sawtooth', 0.3, now + 0.2, 0.15); } } catch (e) { } } };

    const UserProgressManager = {
        getUser: () => sessionStorage.getItem('username'),
        log: (key, data) => { const u = sessionStorage.getItem('username'); if(!u) return; const k = `mathApp_${key}_${u}`; let list = JSON.parse(localStorage.getItem(k) || '[]'); data.time = new Date().toLocaleString(); list.unshift(data); if(list.length > 100) list.pop(); localStorage.setItem(k, JSON.stringify(list)); },
        logError: (data) => UserProgressManager.log('error', data),
        logHistory: (data) => UserProgressManager.log('history', data),
        showModal: () => { document.getElementById('record-overlay').style.display = 'flex'; UserProgressManager.renderList('error'); },
        closeModal: () => { document.getElementById('record-overlay').style.display = 'none'; },
        renderList: (type, btn) => { if(btn) { document.querySelectorAll('.sub-tab-button').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } const u = sessionStorage.getItem('username'); if(!u) return; const list = JSON.parse(localStorage.getItem(`mathApp_${type}_${u}`) || '[]'); const container = document.getElementById('record-list-container'); if(list.length === 0) { container.innerHTML = `<div style="text-align:center;color:#999;padding:50px;">ç„¡ç´€éŒ„</div>`; return; } container.innerHTML = list.map(item => `<div style="border-bottom:1px solid #eee;padding:10px;"><div><small style="color:#999;">${item.time}</small><div style="font-weight:bold;">${item.title||item.topic} ${item.quizId?`(${item.quizId})`:''}</div>${type==='error'?`<span style="color:#f72585;">èª¤é¸:${item.wrong} | æ­£è§£:${item.correct}</span>`:''}</div></div>`).join(''); },
        downloadHTML: () => { const u = sessionStorage.getItem('username'), name = sessionStorage.getItem('displayName'); if(!u) return; const errs = JSON.parse(localStorage.getItem(`mathApp_error_${u}`) || '[]'); const hists = JSON.parse(localStorage.getItem(`mathApp_history_${u}`) || '[]'); const generateRows = (list, type) => list.map(item => `<div class="card"><div class="time">${item.time}</div><div class="title">${item.title || item.topic} ${item.quizId ? `(ID:${item.quizId})`:''}</div>${type === 'error' ? `<div style="color:red">èª¤é¸: ${item.wrong} | æ­£è§£: ${item.correct}</div>` : `<div>${item.detail}</div>`}</div>`).join(''); const fileContent = `<html><body><h1>${name} å­¸ç¿’æª”æ¡ˆ</h1><h2>éŒ¯é¡Œ</h2>${generateRows(errs,'error')}<h2>æ­·ç¨‹</h2>${generateRows(hists,'history')}</body></html>`; const blob = new Blob([fileContent], {type:'text/html;charset=utf-8;'}); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `${name}_å­¸ç¿’æª”æ¡ˆ.html`; document.body.appendChild(link); link.click(); document.body.removeChild(link); },
        
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ­£ï¼šåŠ å…¥ quiz-result-view åˆ¤æ–·ï¼Œç¢ºä¿ 7.71 ç‰ˆåˆ†æ•¸èƒ½æ­£ç¢ºé€å‡º â˜…â˜…â˜…
        uploadToCloud: async (source = 'quiz') => {
            const isAuto = (source === 'auto');
            let btn = document.getElementById('btn-cloud-upload') || document.getElementById('btn-sidebar-upload') || document.getElementById('btn-modal-upload');
            const originalText = '<i class="fas fa-robot"></i> è‡ªå‹•ä¸Šå‚³ä¸­';
            if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...'; }
            
            const u = sessionStorage.getItem('username'), name = sessionStorage.getItem('displayName');
            if (!u) { 
                if(!isAuto) alert("è«‹å…ˆç™»å…¥"); 
                if(btn) { btn.disabled=false; btn.innerHTML = originalText; }
                return; 
            }
            
            const errKey = `mathApp_error_${u}`, histKey = `mathApp_history_${u}`;
            const errorData = localStorage.getItem(errKey) || '[]';
            let traceList = []; try { const rawHist = JSON.parse(localStorage.getItem(histKey) || '[]'); traceList = rawHist.map(item => item.title || item.topic || item.quizId || "æœªçŸ¥"); } catch (e) {}
            
            let currentTopic = new URLSearchParams(window.location.search).get('topic') || 'ç¶œåˆå­¸ç¿’';
            let status = "è§€å¿µå­¸ç¿’ä¸­";
            let rate = "ä¸Šèª²ä¸­";
            let calculatedScore = "";
            let currentCorrect = 0, currentTotal = 0;

            // [FIX] æ–°å¢åˆ¤å®šï¼šdocument.getElementById('quiz-result-view')
            if (document.getElementById('quiz-view-active') || document.querySelector('.score-circle') || document.getElementById('quiz-result-view')) {
                status = currentQuizLevel;
                const s = quizScores[currentQuizLevel];
                currentCorrect = s.correct;
                currentTotal = s.total;
                
                if (s.total > 0) {
                    let scoreVal = Math.round((s.correct / s.total) * 100);
                    calculatedScore = scoreVal;
                    rate = scoreVal + '%';
                } else {
                    calculatedScore = 0;
                    rate = '0%';
                }
            }

            const payload = { 
                subject: 'Math', 
                username: u, 
                name: name, 
                topic: currentTopic, 
                level: status, 
                correct: currentCorrect, 
                total: currentTotal, 
                score: calculatedScore,
                rate: rate, 
                errorDetail: errorData, 
                trace: traceList 
            };
            
            try { 
                await fetch(GAS_EXEC_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }); 
                if(!isAuto) alert(`âœ… ä¸Šå‚³æˆåŠŸï¼`); 
                else console.log('Auto upload success, Score:', calculatedScore);
                if(btn) { btn.innerHTML = 'âœ… å·²å­˜æª”'; setTimeout(() => { btn.disabled = false; btn.innerHTML = originalText; }, 3000); } 
            } catch (error) { 
                if(!isAuto) alert("âŒ ä¸Šå‚³å¤±æ•—"); 
                if(btn) { btn.disabled = false; btn.innerHTML = originalText; } 
            }
        }
    };

    async function loadMarqueeText() { const pElement = document.getElementById('marquee-text'); if (!pElement) return; try { const response = await fetch(MARQUEE_FILE + '?t=' + Date.now()); let text = (await response.text()).replace(/[\r\n]+/g, ' ').trim() || "æ­¡è¿ä½¿ç”¨æ•¸å­¸æ•™å­¸ç³»çµ±"; const newContent = `${text} ${text}`; if (pElement.textContent !== newContent) pElement.textContent = newContent; } catch (err) { } }
    function joinMeetingRoom() { window.open(`https://meet.jit.si/%E5%A0%AF%E7%BF%B0%E7%B7%9A%E4%B8%8A%E6%95%99%E5%AE%A4#config.prejoinPageEnabled=false&userInfo.displayName="${encodeURIComponent(sessionStorage.getItem('displayName'))}"`, '_blank'); }

    function loadUserDatabase(callback) { Papa.parse(USER_LIST_FILE + '?t=' + Date.now(), { download: true, skipEmptyLines: true, encoding: 'UTF-8', header: true, complete: (res) => { validUsers.clear(); for (const row of res.data) { const user = row['å¸³è™Ÿ'] ? row['å¸³è™Ÿ'].trim() : '', pass = row['å¯†ç¢¼'] ? row['å¯†ç¢¼'].trim() : '', name = row['é¡¯ç¤ºåç¨±'] ? row['é¡¯ç¤ºåç¨±'].trim() : '', topics = row['æ¬Šé™'] ? row['æ¬Šé™'].trim() : ''; if (user && pass) { validUsers.set(user, { password: pass, name: name || user, topics: topics }); const lookupKey = "NAME:" + (name || user); validUsers.set(lookupKey, { realUsername: user, data: { password: pass, name: name || user, topics: topics } }); } } if(callback) callback(); }, error: (err) => { if(callback) callback(); } }); }

    function handleLogin() { SoundFX.init(); const u = document.getElementById('username').value.trim(), p = document.getElementById('password').value; if (validUsers.has(u) && p === validUsers.get(u).password) { const user = validUsers.get(u); startSession(u, user.name, user.topics); } else { document.getElementById('login-error').textContent = 'å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤'; } }
    function handleLogout() { if(confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) { sessionStorage.clear(); location.reload(); } }
    
    function startSession(id, name, topics) {
        sessionStorage.setItem('isLoggedIn', 'true'); sessionStorage.setItem('username', id); sessionStorage.setItem('displayName', name); sessionStorage.setItem('allowedTopics', topics);
        document.getElementById('login-overlay').style.display = 'none'; 
        document.getElementById('app-wrapper').style.display = 'block';
        const badge = document.getElementById('user-badge');
        document.getElementById('badge-name').innerText = name;
        badge.style.display = 'flex';
        loadMarqueeText(); setInterval(loadMarqueeText, 60000); initializeApp();
    }

    function fetchCSV(url) { return new Promise((resolve, reject) => { const separator = url.includes('?') ? '&' : '?'; fetch(url + separator + 't=' + Date.now()).then(r => r.text()).then(encryptedText => { try { const decrypted = CryptoJS.AES.decrypt(encryptedText.trim(), SECRET_KEY).toString(CryptoJS.enc.Utf8); const csvContent = decrypted || encryptedText; const result = Papa.parse(csvContent, { header: false, skipEmptyLines: true }); resolve(result.data.slice(1)); } catch (e) { Papa.parse(encryptedText, { header: false, skipEmptyLines: true, complete: (res) => resolve(res.data.slice(1)), error: reject }); } }).catch(reject); }); }
    function sanitizeUrl(url) { return (!url || url.trim()==='' || url==='?') ? '#' : (url.trim().startsWith('http') ? url.trim() : 'https://'+url.trim()); }
    function convertYoutubeUrl(url) { const clean = sanitizeUrl(url); if(clean === '#') return ""; let vid = clean.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/) || clean.match(/watch\?v=([a-zA-Z0-9_-]{11})/); return vid ? `https://www.youtube.com/embed/${vid[1]}?rel=0&modestbranding=1&iv_load_policy=3` : ""; }
    function getMediaHtml(url, type='img') { const safeUrl = sanitizeUrl(url); if(type === 'vid') { return `<div class="media-container"><iframe src="${convertYoutubeUrl(url)}" sandbox="allow-scripts allow-same-origin allow-presentation" allowfullscreen></iframe></div>`; } if (!url || safeUrl === '#' || url === 'å“‡!æ²’æœ‰å–”') return `<div class="media-container" style="background:#f8f9fa; color:#999;">ç„¡åœ–ç‰‡</div>`; if (safeUrl.includes('drive.google.com') || safeUrl.includes('docs.google.com')) { return `<div class="media-container" style="flex-direction:column;"><p style="color:#fff; font-weight:bold; margin-bottom:15px;">Google Drive é›²ç«¯æª”æ¡ˆ</p><a href="${safeUrl}" target="_blank" class="nav-btn btn-next" style="width:auto; text-decoration:none;">ğŸ”— å¦é–‹è¦–çª—è§€çœ‹</a></div>`; } return `<div class="media-container"><img src="${safeUrl}" class="question-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"><div class="fallback-msg" style="display:none; flex-direction:column; align-items:center; gap:15px;"><p style="color:#fff; font-weight:bold;">åœ–ç‰‡ç„¡æ³•ç›´æ¥é è¦½</p><a href="${safeUrl}" target="_blank" class="nav-btn btn-next" style="width:auto; text-decoration:none;">ğŸ”— é»æ­¤å¦é–‹è¦–çª—è§€çœ‹</a></div></div>`; }
    const normalize = (str) => str ? str.toString().replace(/ï¼š/g, ':').trim() : '';

    async function initializeApp() {
        try { const topic = new URLSearchParams(window.location.search).get('topic'); app.innerHTML = `<div style="text-align:center;margin-top:20%"><h1>Loading...</h1></div>`; const allData = await fetchCSV(ALL_DATA_FILE); if (topic) renderLearningPage(topic, allData); else renderTopicList(allData); } catch (err) { app.innerHTML = `<div style="text-align:center;margin-top:20%;color:red">è³‡æ–™è¼‰å…¥å¤±æ•—</div>`; }
    }
    
    function toggleGroup(groupId) { const content = document.getElementById('group-' + groupId); const header = document.getElementById('header-' + groupId); if (content.classList.contains('show')) { content.classList.remove('show'); header.classList.remove('active'); } else { content.classList.add('show'); header.classList.add('active'); } }
    function renderTopicList(allData) { const auth = sessionStorage.getItem('allowedTopics') || ''; const allowed = new Set(auth.split(';').map(t => t.trim())); const isSuperUser = (auth.toUpperCase() === 'ALL'); let topicToCategoryMap = new Map(); allData.forEach(r => { if (r[COL_KEY_TOPIC] && r[COL_KEY_TOPIC].trim() !== '') { const topicName = r[COL_KEY_TOPIC].trim(); const category = r[COL_TOPIC_CATEGORY] ? r[COL_TOPIC_CATEGORY].trim() : ''; if (category !== '') { topicToCategoryMap.set(topicName, category); } else if (!topicToCategoryMap.has(topicName)) { topicToCategoryMap.set(topicName, 'å…¶ä»–å–®å…ƒ'); } } }); let groupedByMain = {}; for (const [topicName, subCategory] of topicToCategoryMap) { if (isSuperUser || allowed.has(topicName)) { let mainCategory = 'others'; const match = subCategory.match(/^(m\d+)/i); if (match) { mainCategory = match[1].toLowerCase(); } else if (subCategory.includes('å–®å…ƒè€ƒè©¦')) { mainCategory = 'exam'; } if (!groupedByMain[mainCategory]) groupedByMain[mainCategory] = {}; if (!groupedByMain[mainCategory][subCategory]) groupedByMain[mainCategory][subCategory] = []; groupedByMain[mainCategory][subCategory].push(topicName); } } const mainKeys = Object.keys(groupedByMain); if (mainKeys.length === 0) { app.innerHTML = `<div style="text-align:center; padding:50px;">ç„¡å¯ç”¨èª²ç¨‹ (è«‹æª¢æŸ¥ login.csv æ¬Šé™æ˜¯å¦è¨­ç‚º ALL)</div>`; return; } mainKeys.sort((a, b) => { if (a === 'others') return 1; if (b === 'others') return -1; return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }); }); let contentHtml = '<div class="catalog-container">'; mainKeys.forEach((mainKey, index) => { let displayName = ''; if (mainKey === 'others') displayName = 'ğŸ“š å…¶ä»–èª²ç¨‹'; else if (mainKey === 'exam') displayName = 'ğŸ“ å–®å…ƒè€ƒè©¦å°ˆå€'; else displayName = `ğŸ“˜ ${mainKey.toUpperCase()} èª²ç¨‹`; const isActive = false; contentHtml += `<div class="main-group-container main-group-${mainKey}"><div id="header-${mainKey}" class="main-category-title ${isActive ? 'active' : ''}" onclick="toggleGroup('${mainKey}')"><span>${displayName}</span><span class="toggle-arrow">â–¼</span></div>`; contentHtml += `<div id="group-${mainKey}" class="group-content ${isActive ? 'show' : ''}">`; const subGroups = groupedByMain[mainKey]; const subKeys = Object.keys(subGroups).sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })); subKeys.forEach(subKey => { const list = subGroups[subKey]; list.sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })); contentHtml += `<div class="topic-section"><div class="section-header">${subKey} <span style="font-size:0.8rem; color:#999; margin-left:10px; font-weight:normal;">(${list.length} å–®å…ƒ)</span></div><div class="section-grid">${list.map(t => `<a href="?topic=${encodeURIComponent(t)}" class="topic-card">${t}</a>`).join('')}</div></div>`; }); contentHtml += `</div></div>`; }); contentHtml += '</div>'; app.innerHTML = `<div class="app-layout"><nav class="sidebar"><div class="sidebar-header"><h1>æ•™å­¸ç³»çµ±ç›®éŒ„</h1></div><div class="main-stepper"><p style="color:#666; font-size:0.9rem; padding:0 10px;">æ­¡è¿å›ä¾†ï¼Œ<b>${sessionStorage.getItem('displayName')}</b><br>é»æ“Šæ¨™é¡Œå¯å±•é–‹/æ”¶åˆèª²ç¨‹ã€‚</p></div><div class="sidebar-footer"><button class="sidebar-btn btn-meet" onclick="joinMeetingRoom()">ğŸ–¥ï¸ ç·šä¸Šæ•™å®¤</button>
    <button id="btn-sidebar-upload" class="sidebar-btn btn-record" onclick="UserProgressManager.uploadToCloud('sidebar')"><i class="fas fa-robot"></i> è‡ªå‹•ä¸Šå‚³ä¸­</button><a onclick="handleLogout()" class="sidebar-btn btn-back">ç™»å‡º</a></div></nav><main class="main-content" style="background:#f0f2f5;">${contentHtml}</main></div>`; }
    function renderLearningPage(topic, allData) { const topicNorm = normalize(topic); UserProgressManager.logHistory({ type: 'topic', title: topicNorm, detail: 'é€²å…¥å–®å…ƒ' }); if (topicNorm.startsWith('å–®å…ƒè€ƒè©¦')) { const examRow = allData.find(r => normalize(r[COL_KEY_TOPIC]) === topicNorm); if (examRow) { const examName = examRow[COL_EXAM_NAME] ? examRow[COL_EXAM_NAME].trim() : 'å–®å…ƒæ¸¬é©—'; const examLink = examRow[COL_EXAM_LINK] ? sanitizeUrl(examRow[COL_EXAM_LINK]) : '#'; const hasLink = examLink !== '#' && examLink !== ''; app.innerHTML = `<div class="app-layout"><nav class="sidebar"><div class="sidebar-header"><h1>${topicNorm}</h1></div><div class="main-stepper"><div class="step-tab active" style="cursor:default; border-left-color:var(--accent-color); color:var(--accent-color);"><span>ğŸ“ æ¸¬é©—èªªæ˜</span></div></div><div class="sidebar-footer"><a href="index.html" class="sidebar-btn btn-back">â† è¿”å›ç›®éŒ„</a></div></nav><div class="main-content" style="background:#f0f2f5; display:flex; justify-content:center; align-items:center;"><div style="background:#fff; width:90%; max-width:600px; padding:40px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.1); text-align:center;"><div style="font-size:4rem; margin-bottom:20px;">âœï¸</div><h2 style="color:var(--primary-color); font-size:2rem; margin:0 0 15px 0;">${examName}</h2><p style="color:#666; font-size:1.1rem; line-height:1.6; margin-bottom:30px;">é€™æ˜¯æœ¬å–®å…ƒçš„ç·šä¸Šæ¸¬é©—ã€‚<br>è«‹æº–å‚™å¥½ç´™ç­†ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹ä½œç­”ã€‚</p>${hasLink ? `<a href="${examLink}" target="_blank" class="nav-btn btn-next" style="display:inline-block; width:auto; padding:15px 40px; font-size:1.2rem; text-decoration:none;">ğŸš€ å‰å¾€è€ƒè©¦é€£çµ</a>` : `<button disabled class="nav-btn" style="background:#ccc; cursor:not-allowed;">â›” é€£çµå°šæœªé–‹æ”¾</button>`}<div style="margin-top:20px; font-size:0.9rem; color:#999;">(è€ƒè©¦å°‡æ–¼æ–°è¦–çª—é–‹å•Ÿ)</div></div></div></div>`; return; } } const teachData = allData.filter(r => normalize(r[COL_KEY_TOPIC]) === topicNorm && r[COL_TEACH_ID]); const quizDataRaw = allData.filter(r => normalize(r[COL_QUIZ_TOPIC]) === topicNorm && r[COL_QUIZ_ID]); allLearningBlocks = []; let curr = null; teachData.forEach(r => { if(r[COL_TEACH_ID].includes('è§€å¿µ') || r[COL_TEACH_ID].includes('åˆ†æ')) { curr = { concept: r, practice: {'å¿…ä¸Š':[],'é¸B':[],'é¸C':[]}, unlockedLevels: {'å¿…ä¸Š':true,'é¸B':false,'é¸C':false} }; allLearningBlocks.push(curr); } else if(r[COL_TEACH_IMG_URL]) { if(!curr) { curr = { concept: null, practice: {'å¿…ä¸Š':[],'é¸B':[],'é¸C':[]}, unlockedLevels: {'å¿…ä¸Š':true,'é¸B':false,'é¸C':false} }; allLearningBlocks.push(curr); } const diff = (r[COL_TEACH_CATEGORY]||'å¿…ä¸Š').trim(); if(curr.practice[diff]) curr.practice[diff].push(r); else curr.practice['å¿…ä¸Š'].push(r); } }); quizLevels = { C: [], B: [], A: [] }; quizDataRaw.forEach(r => { const ans = (r[COL_QUIZ_ANSWER]||'').trim().toUpperCase(); const marker = (r[COL_QUIZ_TYPE_MARKER]||''); if(marker.includes('é¸') && VALID_MCQ_ANSWERS.has(ans)) { let d = (r[COL_QUIZ_DIFFICULTY]||'C').trim().toUpperCase(); if(!['A', 'B', 'C'].includes(d)) d = 'C'; if(quizLevels[d]) quizLevels[d].push(r); else quizLevels['C'].push(r); } }); ['C','B','A'].forEach(l => { for(let i=quizLevels[l].length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[quizLevels[l][i],quizLevels[l][j]]=[quizLevels[l][j],quizLevels[l][i]];} }); let sbHtml = allLearningBlocks.map((b,i) => `<div id="step-tab-${i+1}" class="step-tab" onclick="goToStep(${i+1})"><span>${i+1}. ${b.concept?b.concept[COL_TEACH_ID].split(' ')[0]:'è£œå……'}</span></div>`).join(''); if (allLearningBlocks.length > 0 || (quizLevels.A.length + quizLevels.B.length + quizLevels.C.length) > 0) { sbHtml += `<div id="step-tab-${allLearningBlocks.length+1}" class="step-tab" onclick="goToStep(${allLearningBlocks.length+1})"><span>ğŸ† æœ€çµ‚æŒ‘æˆ°</span></div>`; } else { sbHtml = `<div style="padding:10px; color:#999;">æœ¬å–®å…ƒç„¡æ•™å­¸å…§å®¹</div>`; } app.innerHTML = `<div class="app-layout"><nav class="sidebar"><div class="sidebar-header"><h1>${topicNorm}</h1></div><div class="main-stepper">${sbHtml}</div><div class="sidebar-footer"><a href="index.html" class="sidebar-btn btn-back">â† è¿”å›ç›®éŒ„</a><button id="btn-sidebar-upload" class="sidebar-btn btn-record" onclick="UserProgressManager.uploadToCloud('sidebar')"><i class="fas fa-robot"></i> è‡ªå‹•ä¸Šå‚³ä¸­</button></div></nav><div class="main-content" id="main-container"></div></div>`; unlockedMainSteps = new Set([1]); if (allLearningBlocks.length > 0) { goToStep(1); } else if ((quizLevels.A.length + quizLevels.B.length + quizLevels.C.length) > 0) { renderQuizIntro(); } else { document.getElementById('main-container').innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#999;">è³‡æ–™æº–å‚™ä¸­...</div>`; } }
    function goToStep(n) { if(!unlockedMainSteps.has(n)) { alert('è«‹å…ˆå®Œæˆå‰é¢çš„æ­¥é©Ÿï¼'); return; } document.querySelectorAll('.step-tab').forEach((el, i) => { el.classList.remove('active', 'locked'); if(!unlockedMainSteps.has(i+1)) el.classList.add('locked'); if(i+1 === n) el.classList.add('active'); }); currentMainStep = n; const container = document.getElementById('main-container'); container.style.opacity = 0; setTimeout(() => { if(n <= allLearningBlocks.length) renderBlock(n); else renderQuizIntro(); container.style.opacity = 1; }, 150); }
    
    function renderBlock(n) { const block = allLearningBlocks[n-1]; const hasPractice = block.practice['å¿…ä¸Š'].length+block.practice['é¸B'].length+block.practice['é¸C'].length > 0; const vidUrl = block.concept ? block.concept[COL_TEACH_VIDEO_URL] : ''; const view1Html = `<div id="sub-view-1" style="display:flex; width:100%; height:100%;"><div class="media-pane">${block.concept ? getMediaHtml(vidUrl, convertYoutubeUrl(vidUrl)?'vid':'img') : '<div class="media-container" style="background:#eee;color:#999;">è£œå……å–®å…ƒ</div>'}</div><div class="control-pane"><div class="info-header"><div class="info-title">${block.concept?block.concept[COL_TEACH_ID]:'è£œå……ç·´ç¿’'}</div><div class="info-subtitle">Step 1: è§€å¿µå­¸ç¿’</div></div><div class="sub-nav-tabs"><button class="sub-tab-button active">1. è§€å¿µ</button><button class="sub-tab-button" onclick="switchSubView(2)">2. ç·´ç¿’</button></div><p style="color:#666;">è§€çœ‹å·¦å´å½±ç‰‡å¾Œï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹ç·´ç¿’ã€‚</p><div class="control-footer"><button class="nav-btn btn-finish" onclick="switchSubView(2)">${hasPractice ? 'ğŸ‘‚ è½è€å¸«èªª' : 'ä¸‹ä¸€æ­¥'} &rarr;</button></div></div></div>`; const view2Html = `<div id="sub-view-2" style="display:none; width:100%; height:100%;"><div class="media-pane" id="practice-media-area"></div><div class="control-pane"><div class="info-header"><div class="info-title" id="practice-title">...</div><div class="info-subtitle">Step 2: è€å¸«è¬›è§£</div></div><div class="sub-nav-tabs"><button class="sub-tab-button" onclick="switchSubView(1)">1. è§€å¿µ</button><button class="sub-tab-button active">2. ç·´ç¿’</button></div><div id="diff-tabs" class="diff-group"></div><div style="font-weight:bold; color:#888; margin-bottom:10px;">é€²åº¦ï¼š<span id="practice-counter">1/1</span></div><div class="control-footer"><div class="nav-row"><button class="nav-btn btn-prev" onclick="prevPrac()">â¬… ä¸Šä¸€é¡Œ</button><button class="nav-btn btn-next" onclick="nextPrac()" id="btn-prac-next">çœ‹è¬›è§£ â¡</button></div><button id="btn-next-step" class="nav-btn btn-finish" onclick="unlockNext(${n+1})" disabled style="background:#ccc;">æ­¤éšæ®µå°šæœªå®Œæˆ</button></div></div></div>`; document.getElementById('main-container').innerHTML = view1Html + view2Html; if(hasPractice) { let startLv = block.practice['å¿…ä¸Š'].length===0 ? (block.practice['é¸B'].length?'é¸B':'é¸C') : 'å¿…ä¸Š'; const tabsContainer = document.getElementById('diff-tabs'); tabsContainer.innerHTML = PRACTICE_LEVELS_ORDER.map(lv => { if(!block.practice[lv].length) return ''; const isLocked = !block.unlockedLevels[lv]; return `<button class="diff-btn ${isLocked?'':'active'}" onclick="loadPractice('${lv}')" ${isLocked?'disabled':''}>${lv} (${block.practice[lv].length})</button>`; }).join(''); loadPractice(startLv); } else { const btn = document.getElementById('btn-next-step'); if(btn) { btn.disabled=false; btn.innerText='å®Œæˆï¼Œä¸‹ä¸€æ­¥ â†’'; btn.style.background='var(--success-color)'; } } setTimeout(() => UserProgressManager.uploadToCloud('auto'), 1500); }
    let currPrac = { lv: '', idx: 0, showVid: false }; window.switchSubView = (v) => { document.getElementById('sub-view-1').style.display = v===1?'flex':'none'; document.getElementById('sub-view-2').style.display = v===2?'flex':'none'; }; window.loadPractice = (lv) => { if(!allLearningBlocks[currentMainStep-1].unlockedLevels[lv]) return; const tabs = document.getElementById('diff-tabs').children; for(let btn of tabs) { if(btn.innerText.includes(lv)) { btn.classList.add('active'); } else { btn.classList.remove('active'); } } currPrac = { lv: lv, idx: 0, showVid: false }; renderPracticeItem(); }; window.renderPracticeItem = () => { const block = allLearningBlocks[currentMainStep-1]; const item = block.practice[currPrac.lv][currPrac.idx]; const mediaArea = document.getElementById('practice-media-area'); document.getElementById('practice-title').innerText = currPrac.showVid ? `${item[COL_TEACH_ID]} (è¬›è§£)` : item[COL_TEACH_ID]; document.getElementById('practice-counter').innerText = `${currPrac.idx+1} / ${block.practice[currPrac.lv].length}`; const nextBtn = document.getElementById('btn-prac-next'); const isLast = currPrac.idx === block.practice[currPrac.lv].length-1; nextBtn.innerHTML = currPrac.showVid ? (isLast ? 'å®Œæˆæœ¬ç´š â¡' : 'ä¸‹ä¸€é¡Œ â¡') : 'çœ‹è¬›è§£ â¡'; if(currPrac.showVid) { mediaArea.innerHTML = getMediaHtml(item[COL_TEACH_VIDEO_URL], 'vid'); UserProgressManager.logHistory({ title: item[COL_TEACH_ID], detail: 'è§€çœ‹è¬›è§£' }); } else { mediaArea.innerHTML = getMediaHtml(item[COL_TEACH_IMG_URL], 'img'); } }; window.prevPrac = () => { if(currPrac.showVid) currPrac.showVid=false; else if(currPrac.idx>0) { currPrac.idx--; currPrac.showVid=true; } renderPracticeItem(); }; window.nextPrac = () => { if(!currPrac.showVid) currPrac.showVid=true; else if(currPrac.idx < allLearningBlocks[currentMainStep-1].practice[currPrac.lv].length-1) { currPrac.idx++; currPrac.showVid=false; } else finishPracticeLevel(); renderPracticeItem(); }; window.finishPracticeLevel = () => { SoundFX.play('correct'); confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } }); const block = allLearningBlocks[currentMainStep-1]; if(currPrac.lv === 'å¿…ä¸Š') { block.unlockedLevels['é¸B'] = true; block.unlockedLevels['é¸C'] = true; const btn = document.getElementById('btn-next-step'); if(btn) { btn.disabled=false; btn.innerHTML='å‰å¾€ä¸‹ä¸€æ­¥ &rarr;'; btn.style.background='var(--success-color)'; } const tabsContainer = document.getElementById('diff-tabs'); tabsContainer.innerHTML = PRACTICE_LEVELS_ORDER.map(lv => { if(!block.practice[lv].length) return ''; const isLocked = !block.unlockedLevels[lv]; return `<button class="diff-btn ${isLocked?'':'active'}" onclick="loadPractice('${lv}')" ${isLocked?'disabled':''}>${lv} (${block.practice[lv].length})</button>`; }).join(''); alert('ğŸ‰ å¿…ä¸Šç·´ç¿’å®Œæˆï¼å·²è§£é–é€²éšé¡Œèˆ‡ä¸‹ä¸€æ­¥ã€‚'); } else alert('ğŸ‰ æœ¬ç´šç·´ç¿’å®Œæˆï¼'); }; window.unlockNext = (n) => { unlockedMainSteps.add(n); goToStep(n); }; window.renderQuizIntro = () => { const total = quizLevels.C.length + quizLevels.B.length + quizLevels.A.length; let start = quizLevels.C.length ? 'C' : (quizLevels.B.length ? 'B' : 'A'); document.getElementById('main-container').innerHTML = `<div style="flex:1; display:flex; justify-content:center; align-items:center;"><div style="text-align:center; padding:50px; background:#fff; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.1);"><h1 style="font-size:3rem; color:var(--primary-color); margin-bottom:10px;">ğŸ† æœ€çµ‚æª¢æ ¸</h1><p style="font-size:1.2rem; color:#666;">ç¸½é¡Œæ•¸ï¼š<strong>${total}</strong> é¡Œ</p>${total>0 ? `<button class="nav-btn btn-next" style="font-size:1.5rem; padding:20px 60px; margin-top:30px;" onclick="startQuiz('${start}')">ğŸš€ é–‹å§‹æŒ‘æˆ°</button>` : '<p style="color:red;">ç„¡é¡Œç›®</p>'}</div></div>`; }; 
    window.startQuiz = (lv) => { currentQuizLevel = lv; currentQuizIndex = 0; const pool = [...quizLevels[lv]]; for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]];} currentQuizBatch = pool.slice(0, QUIZ_BATCH_SIZE); quizScores[lv] = { correct: 0, total: currentQuizBatch.length }; renderQuizQuestion(); UserProgressManager.uploadToCloud('auto'); }; window.renderQuizQuestion = () => { if(currentQuizIndex >= currentQuizBatch.length) { renderQuizResult(); return; } const item = currentQuizBatch[currentQuizIndex]; const progress = ((currentQuizIndex + 1) / currentQuizBatch.length) * 100; document.getElementById('main-container').innerHTML = `<div id="quiz-view-active" style="display:flex; width:100%; height:100%;"><div class="media-pane" id="quiz-media-area">${getMediaHtml(item[COL_QUIZ_IMG_URL], 'img')}</div><div class="control-pane"><div class="info-header"><div class="info-title">LEVEL ${currentQuizLevel}</div><div class="info-subtitle">ç¬¬ ${currentQuizIndex+1} / ${currentQuizBatch.length} é¡Œ</div></div><div class="progress-bar-container"><div class="progress-bar-fill" style="width:${progress}%"></div></div><p style="font-weight:bold; color:#666;">è«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼š</p><div class="answer-grid">${['A','B','C','D'].map(opt => `<button class="answer-btn" onclick="checkQuizAns('${opt}')"><span translate="no">${opt}</span></button>`).join('')}</div><div id="quiz-feedback" class="feedback-text"></div><div class="control-footer"><button id="btn-quiz-next" class="nav-btn btn-next" style="display:none;" onclick="nextQuiz()">ä¸‹ä¸€é¡Œ &rarr;</button></div></div></div>`; }; window.checkQuizAns = (ans) => { const item = currentQuizBatch[currentQuizIndex]; const correct = (item[COL_QUIZ_ANSWER]||'').trim().toUpperCase(); const isRight = ans === correct; document.querySelectorAll('.answer-btn').forEach(b => { b.disabled = true; if(b.innerText === correct) { b.style.borderColor = 'var(--success-color)'; b.style.background = '#e6fffa'; b.style.color='var(--success-color)'; } else if(b.innerText === ans && !isRight) { b.style.borderColor = 'var(--accent-color)'; b.style.background = '#ffe5ec'; b.style.color='var(--accent-color)'; } }); const fb = document.getElementById('quiz-feedback'); const mediaArea = document.getElementById('quiz-media-area'); if(isRight) { quizScores[currentQuizLevel].correct++; fb.innerHTML = `<span style="color:var(--success-color)">ğŸ‰ æ­£ç¢ºï¼</span>`; SoundFX.play('correct'); confetti({ particleCount: 80, spread: 60, origin: { x:0.7, y: 0.6 } }); } else { fb.innerHTML = `<span style="color:var(--accent-color)">ğŸ’¥ éŒ¯èª¤ï¼Œè«‹çœ‹è©³è§£å½±ç‰‡</span>`; SoundFX.play('wrong'); UserProgressManager.logError({ topic: item[COL_QUIZ_TOPIC], quizId: item[COL_QUIZ_ID], wrong: ans, correct: correct }); mediaArea.innerHTML = getMediaHtml(item[COL_QUIZ_VIDEO_URL], 'vid'); } document.getElementById('btn-quiz-next').style.display = 'flex'; }; window.nextQuiz = () => { currentQuizIndex++; renderQuizQuestion(); }; 
    
    // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ­£ï¼šç‚ºæˆç¸¾ç•«é¢åŠ å…¥ ID (quiz-result-view) â˜…â˜…â˜…
    window.renderQuizResult = () => { const s = quizScores[currentQuizLevel]; const pass = (s.correct / s.total) > PROMOTION_THRESHOLD; let html = `<div id="quiz-result-view" style="flex:1; display:flex; justify-content:center; align-items:center;"><div style="text-align:center; padding:40px; background:#fff; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.1); width:400px;"><h2 style="color:var(--text-main);">${currentQuizLevel} ç´š çµæœ</h2><div style="font-size:4rem; font-weight:900; color:${pass?'var(--success-color)':'var(--accent-color)'}; margin:20px 0;">${Math.round((s.correct/s.total)*100)}<span style="font-size:1.5rem;">%</span></div><p style="font-size:1.1rem; margin-bottom:30px;">${pass ? 'ğŸ‰ æ­å–œé€šéï¼' : 'ğŸ’ª è«‹å†æ¥å†å²ï¼'}</p><div style="display:flex; gap:10px; flex-direction:column;"><div style="display:flex; gap:10px;"><button id="btn-cloud-upload" class="nav-btn btn-prev" onclick="UserProgressManager.uploadToCloud()"><i class="fas fa-robot"></i> è‡ªå‹•ä¸Šå‚³ä¸­</button><button class="nav-btn btn-prev" onclick="UserProgressManager.guideFileUpload()">ğŸ“‚ ä¸‹è¼‰å‚™ä»½</button></div>${pass ? (currentQuizLevel==='C' && quizLevels.B.length ? `<button class="nav-btn btn-next" onclick="startQuiz('B')">æŒ‘æˆ° B ç´š &rarr;</button>` : (currentQuizLevel==='B' && quizLevels.A.length ? `<button class="nav-btn btn-next" onclick="startQuiz('A')">æŒ‘æˆ° A ç´š &rarr;</button>` : `<div style="color:var(--success-color); font-weight:bold; font-size:1.2rem;">å…¨æ•¸é€šé</div>`)) : `<button class="nav-btn btn-next" onclick="startQuiz('${currentQuizLevel}')">ğŸ”„ é‡è©¦</button>`}</div></div></div>`; document.getElementById('main-container').innerHTML = html; UserProgressManager.uploadToCloud('auto'); };

    (function(){
        const urlParams = new URLSearchParams(window.location.search);
        const autoUser = (urlParams.get('user') || '').trim();
        const autoPwd = (urlParams.get('pwd') || '').trim();
        const autoName = (urlParams.get('name') || '').trim(); 

        if (autoUser) {
            document.getElementById('marquee-text').textContent = "æ­£åœ¨é©—è­‰èº«ä»½...";
            if (autoPwd) {
                 startSession(autoUser, autoName || autoUser, 'ALL');
            } else {
                loadUserDatabase(() => {
                    let userObj = null; 
                    if (validUsers.has(autoUser)) userObj = validUsers.get(autoUser); 
                    else if (validUsers.has("NAME:" + autoUser)) userObj = validUsers.get("NAME:" + autoUser).data;
                    
                    if (userObj) startSession(autoUser, userObj.name, userObj.topics);
                    else { alert("è‡ªå‹•ç™»å…¥å¤±æ•—ï¼šæ‰¾ä¸åˆ°ä½¿ç”¨è€…"); document.getElementById('login-overlay').style.display='flex'; }
                });
            }
        } else if(sessionStorage.getItem('isLoggedIn')==='true'){ 
            startSession(sessionStorage.getItem('username'), sessionStorage.getItem('displayName'), sessionStorage.getItem('allowedTopics'));
        } else { 
            loadUserDatabase(); 
        }
        document.getElementById('password').addEventListener('keypress', e=>{if(e.key==='Enter')handleLogin()});
    })();
</script>
</body>
</html>