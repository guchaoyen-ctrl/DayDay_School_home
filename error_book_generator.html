<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DayDayè€å¸« - éŒ¯é¡Œæ¶ˆæ»…ç³»çµ± V9.2 (æˆ°åŠ›åŒæ­¥ç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root { --primary: #4361ee; --dark: #1e293b; --light: #f8fafc; --accent: #f72585; --success: #10b981; --ai: #7209b7; --warn: #f59e0b; }
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background: #e2e8f0; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .control-panel { background: #fff; padding: 20px 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 900px; margin-bottom: 30px; transition: all 0.3s; }
        .control-header { display: flex; justify-content: center; align-items: center; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 15px; position: relative; }
        h1 { margin: 0; color: var(--primary); font-size: 1.5rem; display:flex; align-items:center; gap:10px; }
        .badge { background: var(--success); color: #fff; font-size: 0.8rem; padding: 3px 8px; border-radius: 4px; }
        .badge-ai { background: var(--ai); }

        .config-drawer { border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; margin-bottom: 20px; background: #f8fafc; }
        .config-header { padding: 10px 15px; background: #f1f5f9; cursor: pointer; font-weight: bold; color: #64748b; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; user-select: none; }
        .config-header:hover { background: #e2e8f0; color: var(--dark); }
        .config-body { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease; background: #fff; }
        .config-drawer.open .config-body { padding: 15px; max-height: 300px; border-top: 1px solid #e2e8f0; }

        .command-bar { margin-top: 20px; padding: 15px; background: #f0fdf4; border: 2px solid #bbf7d0; border-radius: 10px; display: none; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px; animation: slideDown 0.3s; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .role-switcher { display: flex; background: #fff; padding: 4px; border-radius: 8px; gap: 5px; border: 1px solid #cbd5e1; }
        .role-btn { border: none; background: transparent; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; color: #64748b; transition: 0.2s; font-size: 0.9rem; }
        .role-btn.active { background: #f1f5f9; color: var(--dark); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .role-btn.teacher.active { color: var(--primary); border-left: 3px solid var(--primary); }
        .role-btn.student.active { color: var(--success); border-left: 3px solid var(--success); }

        .print-options { display: flex; align-items: center; gap: 15px; }
        .qr-toggle-label { display: flex; align-items: center; gap: 5px; font-weight: bold; color: #475569; cursor: pointer; user-select: none; font-size: 0.9rem; }
        .qr-toggle-label input { width: 16px; height: 16px; cursor: pointer; }

        /* ID å°å‡ºå€èˆ‡é›²ç«¯æ¸¬é©—å€ */
        .id-export-area { width: 100%; margin-top: 10px; border-top: 1px dashed #86efac; padding-top: 15px; display: flex; flex-direction: column; gap: 8px; }
        .id-row { display: flex; align-items: center; gap: 10px; }
        .id-label { font-weight: bold; color: #166534; font-size: 0.9rem; min-width: 85px; white-space: nowrap; }
        .id-input { flex: 1; padding: 6px 10px; border: 1px solid #86efac; border-radius: 4px; font-family: monospace; color: #14532d; background: #fff; font-size: 0.85rem; }
        .id-input:focus { outline: 2px solid #166534; }
        .btn-copy { padding: 6px 12px; background: #fff; border: 1px solid #166534; color: #166534; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: 0.2s; white-space: nowrap; font-weight: bold; }
        .btn-copy:hover { background: #166534; color: #fff; }

        .filter-section { background: #fff; border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .filter-title { font-weight:bold; color:var(--dark); margin-bottom:10px; display:flex; align-items:center; gap:5px; }
        .filter-presets { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .preset-btn { padding: 6px 12px; border: 1px solid #cbd5e1; background: #fff; border-radius: 20px; cursor: pointer; font-size: 0.9rem; color: #64748b; transition: 0.2s; }
        .preset-btn:hover { background: #f1f5f9; color: var(--primary); border-color: var(--primary); }
        .preset-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

        .date-range { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        .date-input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; }
        .limit-setting { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; color: #64748b; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 15px; border: 2px solid #e2e8f0; background: #fff; border-radius: 8px; cursor: pointer; font-weight: bold; color: #64748b; transition: 0.2s; text-align: center; }
        .tab-btn:hover { background: #f8fafc; }
        .tab-btn.active { border-color: var(--primary); color: var(--primary); background: #eff6ff; }
        .tab-btn.ai-tab.active { border-color: var(--ai); color: var(--ai); background: #f3e8ff; }
        
        .mode-content { display: none; animation: fadeIn 0.3s; }
        .mode-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .btn { padding: 12px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; color: #fff; font-size: 1rem; }
        .btn-load { background: var(--primary); width: 100%; margin-top: 15px; } 
        .btn-ai { background: var(--ai); width: 100%; margin-top: 15px; }
        .btn-analyze { background: var(--warn); color: white; padding: 8px 15px; font-size: 0.9rem; margin-top:0; width: auto; white-space: nowrap;}
        .btn-print { background: #10b981; display: flex; align-items: center; gap: 5px; }
        .btn-print:hover { background: #059669; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--dark); }
        input[type="text"], textarea, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-size: 1rem; background: #fff; }
        
        /* æœå°‹æ¡†æ¨£å¼å„ªåŒ– */
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-bottom: none; /* èˆ‡ä¸‹æ–¹ select é€£æ¥ */
            border-radius: 6px 6px 0 0;
            font-size: 0.9rem;
            background: #f8fafc;
            color: #334155;
        }
        .search-input:focus {
            outline: none;
            background: #fff;
            border-color: var(--primary);
        }

        select.student-menu {
            cursor: pointer;
            border: 2px solid #cbd5e1;
            border-radius: 0 0 6px 6px; /* é…åˆä¸Šæ–¹æœå°‹æ¡† */
            color: #334155;
            font-weight: bold;
            margin-top: -1px; /* æ¶ˆé™¤é‚Šæ¡†é‡ç–Š */
        }
        select.student-menu:focus { border-color: var(--primary); outline: none; }

        #status { margin-top:15px; padding: 15px; border-radius: 6px; background: #f0fdf4; color: #166534; font-weight:bold; display: none; white-space: pre-wrap; line-height: 1.5; }
        #status.error { background: #fef2f2; color: #991b1b; }
        #status.ai-info { background: #f3e8ff; color: #5b21b6; }

        .page { background: #fff; width: 210mm; min-height: 297mm; padding: 20mm; margin: 0 auto 20px auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); box-sizing: border-box; position: relative; }
        .book-header { text-align: center; border-bottom: 3px double var(--primary); padding-bottom: 10px; margin-bottom: 20px; }
        .book-title { font-size: 24px; font-weight: 900; color: #000; margin: 0; }
        .book-sub { font-size: 14px; color: #666; margin-top: 5px; }
        .question-row { display: flex; gap: 20px; margin-bottom: 30px; break-inside: avoid; border-bottom: 1px dashed #ccc; padding-bottom: 20px; }
        .q-col { flex: 1; display: flex; flex-direction: column; }
        
        .q-label { font-size: 12px; font-weight: bold; color: #fff; background: #000; padding: 2px 8px; border-radius: 4px; display: inline-block; margin-bottom: 10px; width: fit-content; }
        .q-label.original { background: #ef4444; } 
        .q-label.similar { background: #3b82f6; }
        .q-label.ai-weakness { background: #7209b7; } 
        
        .q-content { font-size: 14px; line-height: 1.6; color: #333; flex: 1; }
        .q-img { max-width: 100%; max-height: 150px; object-fit: contain; margin-top: 10px; border: 1px solid #eee; }
        
        .qr-area { margin-top: 10px; display: flex; align-items: center; gap: 10px; }
        .qr-code { width: 60px; height: 60px; }
        .qr-text { font-size: 10px; color: #999; }

        .ans-box { margin-top: 10px; padding: 5px 10px; background: #fff5f5; border-left: 4px solid #ef4444; color: #b91c1c; font-weight: bold; font-size: 0.9rem; display: none; }
        .ans-box.right-col { background: #eff6ff; border-left-color: #3b82f6; color: #1e40af; }

        #book-container.mode-teacher .qr-area { display: flex; }
        #book-container.mode-teacher .q-label { display: inline-block; }
        #book-container.mode-teacher .ans-box { display: block; }

        #book-container.mode-student .qr-area { display: none !important; }
        #book-container.mode-student .q-label { display: none !important; }
        #book-container.mode-student .ans-box { display: none !important; }
        #book-container.mode-student .q-col { border-right-color: transparent !important; min-height: 150px; }
        
        #book-container.hide-qr .qr-area { display: none !important; }

        @media print {
            @page { margin: 0; size: A4; }
            body { background: #fff; padding: 0; margin: 0; -webkit-print-color-adjust: exact; }
            .control-panel { display: none; }
            .page { box-shadow: none; margin: 0; width: 100%; min-height: 297mm; page-break-after: always; overflow: hidden; }
            .page:last-child { page-break-after: auto; margin-bottom: 0; }
            .question-row { page-break-inside: avoid; }
        }
    </style>
</head>
<body>

    <div class="control-panel">
        <div class="control-header">
            <h1>éŒ¯é¡Œæ¶ˆæ»…ç³»çµ± <span class="badge badge-ai">V9.2 æˆ°åŠ›åŒæ­¥ç‰ˆ</span></h1>
        </div>

        <div class="config-drawer" id="config-drawer">
            <div class="config-header" onclick="toggleConfig()">
                <span>âš™ï¸ è³‡æ–™åº«é€£çµè¨­å®š</span>
                <span id="config-arrow">â–¼</span>
            </div>
            <div class="config-body">
                <div class="input-group">
                    <label>ğŸ“š é¡Œç›®è³‡æ–™åº« (Question DB) CSVï¼š</label>
                    <input type="text" id="url-question-db" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vSMZ6vXTQ39GZ2wr-Ce3zBOmc82mYofJDIR2Hp9nRQD5bn8vAuPtJCH-jMO4TXJb6aiZ9NVbmDmZLyF/pub?gid=1355544459&single=true&output=csv">
                </div>
                <div class="input-group">
                    <label>ğŸ“ å­¸ç”Ÿæ­·ç¨‹ (Student DB) CSVï¼š</label>
                    <input type="text" id="url-student-db" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vR95YiWV-IcQ80_369MccfAROg6mu-kwJjy9v3X92Lb8vKORpw_9wmPJj1-Xeii14iChPznFEaO5OU6/pub?gid=423591624&single=true&output=csv">
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab-btn active" onclick="switchMode('cloud')">â˜ï¸ é›²ç«¯éŒ¯é¡Œå¼•æ“</div>
            <div class="tab-btn" onclick="switchMode('manual')">âŒ¨ï¸ æ‰‹å‹•è¼¸å…¥æ¨¡å¼</div>
            <div class="tab-btn ai-tab" onclick="switchMode('ai')">ğŸ¤– AI å¼±é»æ“Šç ´å¼•æ“</div>
        </div>

        <div id="mode-cloud" class="mode-content active">
            <div class="filter-section">
                <div class="filter-title">ğŸ¯ è¨‚è£½è¬›ç¾©ç¯„åœ</div>
                <div class="filter-presets">
                    <button class="preset-btn active" onclick="setPreset('all', this)">å…¨éƒ¨ç´€éŒ„</button>
                    <button class="preset-btn" onclick="setPreset(7, this)">æœ€è¿‘ 7 å¤©</button>
                    <button class="preset-btn" onclick="setPreset(14, this)">æœ€è¿‘ 2 é€±</button>
                    <button class="preset-btn" onclick="setPreset(30, this)">æœ€è¿‘ 1 æœˆ</button>
                </div>
                <div class="date-range">
                    <span>è‡ª</span><input type="date" id="date-start" class="date-input">
                    <span>è‡³</span><input type="date" id="date-end" class="date-input">
                </div>
                <div class="limit-setting">
                    <label style="margin:0; color:#333;">âš ï¸ é¡Œç›®ä¸Šé™ï¼š</label>
                    <input type="number" id="q-limit" value="20" style="width:60px; padding:5px; text-align:center;">
                    <span>é¡Œ (å„ªå…ˆæŠ“å–æœ€æ–°éŒ¯é¡Œ)</span>
                </div>
            </div>
            <div class="input-group">
                <label>è«‹é¸æ“‡å­¸ç”Ÿï¼š(ç³»çµ±å•Ÿå‹•æ™‚å·²è‡ªå‹•è®€å–)</label>
                <div style="display:flex; gap:10px; align-items: flex-end;">
                    <div style="flex:1;">
                        <input type="text" class="search-input" placeholder="ğŸ” è¼¸å…¥å§“åå¿«é€Ÿæœå°‹..." oninput="filterStudents('cloud-user', this.value)">
                        <select id="cloud-user" class="student-menu">
                            <option value="">è®€å–ä¸­...</option>
                        </select>
                    </div>
                    <button class="btn btn-load" style="margin-top:0; width:auto; height: 50px;" onclick="generateFromCloud()">ğŸ” æœå°‹éŒ¯é¡Œ</button>
                </div>
            </div>
        </div>

        <div id="mode-manual" class="mode-content">
            <div class="input-group">
                <label>å­¸ç”Ÿå§“åï¼š</label>
                <input type="text" id="manual-name" placeholder="ä¾‹å¦‚: ç‹å°æ˜">
            </div>
            <div class="input-group">
                <label>éŒ¯é¡Œé¡Œè™Ÿ (ç”¨é€—è™Ÿåˆ†éš”)ï¼š</label>
                <textarea id="manual-ids" placeholder="ä¾‹å¦‚: 10, 25, 33, 10745"></textarea>
            </div>
            <button class="btn btn-load" onclick="generateFromManual()">ğŸš€ é–‹å§‹ç”Ÿæˆ</button>
        </div>

        <div id="mode-ai" class="mode-content">
            <div class="filter-section" style="border-color: var(--ai);">
                <div class="filter-title" style="color: var(--ai);">ğŸ¤– AI æˆ°åŠ›åˆ†æèˆ‡æ´¾å·</div>
                <p style="font-size:0.9rem; color:#666; margin:5px 0;">
                    è«‹é¸æ“‡å­¸ç”Ÿå¾Œé»æ“Šã€Œè‡ªå‹•åˆ†ææˆ°åŠ›ã€ï¼Œç³»çµ±å°‡è¨ˆç®—è©²ç”Ÿå„å–®å…ƒçš„ã€Œæœ€æ–°å³æ™‚æˆ°åŠ›ã€(èˆ‡æŒ‡æ®éƒ¨åŒæ­¥)ã€‚<br>
                    æˆ°åŠ›è¶Šä½ï¼Œç”Ÿæˆçš„é¡Œç›®è¶Šå¤šã€‚
                </p>
            </div>
            <div class="input-group">
                <label>è«‹é¸æ“‡å­¸ç”Ÿï¼š</label>
                <div style="display:flex; gap:10px; align-items: flex-end;">
                    <div style="flex:1;">
                        <input type="text" class="search-input" placeholder="ğŸ” è¼¸å…¥å§“åå¿«é€Ÿæœå°‹..." oninput="filterStudents('ai-name', this.value)">
                        <select id="ai-name" class="student-menu">
                            <option value="">è®€å–ä¸­...</option>
                        </select>
                    </div>
                    <button class="btn btn-analyze" style="height: 50px;" onclick="autoLoadCombatPower()">ğŸ§  è‡ªå‹•åˆ†ææˆ°åŠ›</button>
                </div>
            </div>
            <div class="input-group">
                <label>æˆ°åŠ›æ•¸æ“š (å¯æ‰‹å‹•ä¿®æ”¹)ï¼š</label>
                <textarea id="ai-data" style="height:120px; font-family:monospace;" placeholder="ç³»çµ±è‡ªå‹•å¡«å…¥...&#10;ä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹å¼ 40&#10;ç›´è§’åæ¨™ 100"></textarea>
            </div>
            <button class="btn btn-ai" onclick="generateFromAI()">ğŸ² AI æ™ºèƒ½çµ„å· (10çµ„ç²¾é¸)</button>
        </div>

        <div id="status"></div>

        <div id="command-bar" class="command-bar">
            <div style="display:flex; justify-content:space-between; width:100%; align-items:center; flex-wrap:wrap; gap:10px;">
                <div class="role-switcher">
                    <button class="role-btn teacher active" onclick="setRole('teacher')">ğŸ‘¨â€ğŸ« æ•™ç”¨å· (è©³è§£)</button>
                    <button class="role-btn student" onclick="setRole('student')">ğŸ§‘â€ğŸ“ å­¸ç”Ÿå· (æ¸¬é©—)</button>
                </div>
                
                <div class="print-options">
                    <label class="qr-toggle-label">
                        <input type="checkbox" id="chk-qr" checked onchange="toggleQR()"> é¡¯ç¤º QR Code
                    </label>
                    <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ ç«‹å³åˆ—å°</button>
                </div>
            </div>

            <div class="id-export-area">
                <div class="id-row">
                    <span class="id-label">ğŸ”´ éŒ¯é¡Œ IDï¼š</span>
                    <input type="text" id="export-original" class="id-input" readonly onclick="this.select()">
                    <button class="btn-copy" onclick="copyToClip('export-original')">è¤‡è£½</button>
                </div>
                <div class="id-row">
                    <span class="id-label">ğŸ”µ é¡é¡Œ IDï¼š</span>
                    <input type="text" id="export-similar" class="id-input" readonly onclick="this.select()">
                    <button class="btn-copy" onclick="copyToClip('export-similar')">è¤‡è£½</button>
                </div>

                <div class="id-row" style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #86efac;">
                    <span class="id-label" style="color: #0ea5e9;">â˜ï¸ é›²ç«¯æ¸¬é©—ï¼š</span>
                    <select id="quiz-source" class="id-input" style="flex:0.4; cursor:pointer; font-weight:bold;">
                        <option value="similar">è€ƒé¡é¡Œ (æ¨è–¦)</option>
                        <option value="original">è€ƒåŸéŒ¯é¡Œ</option>
                    </select>
                    <button class="btn" style="background:#0ea5e9; padding: 6px 12px; font-size: 0.85rem; margin-top:0;" onclick="generateOnlineQuiz()">ğŸ”— ç”¢ç”Ÿé€£çµèˆ‡ä»£ç¢¼</button>
                </div>
                
                <div id="quiz-link" style="display:none;"></div>
            </div>
        </div>
    </div>

    <div id="book-container" class="mode-teacher"></div>

<script>
    // â˜…â˜…â˜… [é‡è¦] V9.1 æ–°ç‰ˆç¶²å€ (å·²æ›´æ–°) â˜…â˜…â˜…
    const GAS_EXAM_URL = "https://script.google.com/macros/s/AKfycbw4ylgEaVoWdnQWexyahBMDXq3qJgJzeZUxshuuAOTJ20sCLgYyaBvZ759mL4HT0OhaEA/exec";

    const COL_Q_ID = 8;     
    const COL_Q_TOPIC = 6;  
    const COL_Q_CAT = 13; 
    const COL_Q_IMG = 9;    
    const COL_Q_VIDEO = 11; 
    const COL_Q_ANS = 2; 

    const POSSIBLE_USER_KEYS = ['username', 'user', 'account', 'id', 'å¸³è™Ÿ', 'å­¸è™Ÿ', 'å§“å', 'student'];
    const POSSIBLE_ERROR_KEYS = ['errordetail', 'error', 'detail', 'éŒ¯é¡Œ', 'éŒ¯é¡Œç´€éŒ„', 'éŒ¯èª¤è©³æƒ…'];
    const POSSIBLE_NAME_KEYS = ['name', 'å§“å', 'displayname'];
    const POSSIBLE_SCORE_KEYS = ['score', 'åˆ†æ•¸', 'æˆç¸¾', 'å¾—åˆ†', 'rate'];

    let questionDB = [];
    let studentDB = [];
    let studentErrorMap = {}; 
    let allStudentData = []; // æ–°å¢ï¼šå„²å­˜æ‰€æœ‰å­¸ç”Ÿè³‡æ–™ä¾›æœå°‹ç”¨

    // åˆå§‹åŒ–
    window.onload = function() {
        const today = new Date();
        document.getElementById('date-end').valueAsDate = today;
        initStudentList();
    };

    function toggleConfig() {
        const drawer = document.getElementById('config-drawer');
        const arrow = document.getElementById('config-arrow');
        if (drawer.classList.contains('open')) {
            drawer.classList.remove('open');
            arrow.innerText = 'â–¼';
        } else {
            drawer.classList.add('open');
            arrow.innerText = 'â–²';
        }
    }

    function setRole(role) {
        const container = document.getElementById('book-container');
        document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
        if (role === 'teacher') {
            container.classList.remove('mode-student');
            container.classList.add('mode-teacher');
            document.querySelector('.role-btn.teacher').classList.add('active');
        } else {
            container.classList.remove('mode-teacher');
            container.classList.add('mode-student');
            document.querySelector('.role-btn.student').classList.add('active');
        }
    }

    function toggleQR() {
        const isChecked = document.getElementById('chk-qr').checked;
        const container = document.getElementById('book-container');
        if (isChecked) container.classList.remove('hide-qr');
        else container.classList.add('hide-qr');
    }

    function switchMode(mode) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.mode-content').forEach(c => c.classList.remove('active'));
        if(mode === 'cloud') {
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
            document.getElementById('mode-cloud').classList.add('active');
        } else if (mode === 'manual') {
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            document.getElementById('mode-manual').classList.add('active');
        } else {
            document.querySelectorAll('.tab-btn')[2].classList.add('active');
            document.getElementById('mode-ai').classList.add('active');
        }
        showStatus('', false);
        document.getElementById('command-bar').style.display = 'none';
        document.getElementById('book-container').innerHTML = '';
    }

    function setPreset(days, btn) {
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const endInput = document.getElementById('date-end');
        const startInput = document.getElementById('date-start');
        endInput.valueAsDate = new Date(); 
        if (days === 'all') { startInput.value = ''; } 
        else { const d = new Date(); d.setDate(d.getDate() - days); startInput.valueAsDate = d; }
    }

    function showStatus(msg, type = 'normal') {
        const el = document.getElementById('status');
        if(!msg) { el.style.display = 'none'; return; }
        el.style.display = 'block';
        el.className = ''; 
        if (type === 'error') el.className = 'error';
        if (type === 'ai') el.className = 'ai-info';
        el.innerText = msg;
    }

    function normalizeText(str) {
        if (!str) return "";
        return str.toString().replace(/\s+/g, '').replace(/[:ï¼š]/g, '').replace(/[()ï¼ˆï¼‰]/g, '').toLowerCase();
    }

    async function loadDB(type) {
        const qUrl = document.getElementById('url-question-db').value.trim();
        const sUrl = document.getElementById('url-student-db').value.trim();
        
        if (type === 'question' && questionDB.length > 0) return true;
        if (type === 'student' && studentDB.length > 0) return true;
        
        const targetName = type === 'question' ? 'é¡Œç›®è³‡æ–™åº«' : 'å­¸ç”Ÿæ­·ç¨‹è³‡æ–™åº«';
        
        if (type === 'question') showStatus(`æ­£åœ¨è®€å– ${targetName}...`);

        try {
            const url = type === 'question' ? qUrl : sUrl;
            const separator = url.includes('?') ? '&' : '?';
            const res = await fetch(url + separator + 't=' + Date.now());
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            const text = await res.text();
            
            const result = Papa.parse(text, { header: type === 'student', skipEmptyLines: true });
            if (type === 'question') {
                const rawResult = Papa.parse(text, { header: false, skipEmptyLines: true });
                questionDB = rawResult.data.slice(1); 
            } else {
                studentDB = result.data;
            }
            return true;
        } catch (e) {
            console.error(e);
            showStatus(`âŒ è®€å–å¤±æ•—ï¼šç„¡æ³•å­˜å–ã€Œ${targetName}ã€ã€‚`, 'error');
            return false;
        }
    }

    function findKey(row, possibleKeys) {
        const keys = Object.keys(row);
        for (let k of keys) { if (possibleKeys.includes(k.toLowerCase().trim())) return k; }
        for (let k of keys) { for (let pk of possibleKeys) { if (k.toLowerCase().includes(pk)) return k; } }
        return null;
    }

    // æ–°å¢ï¼šæ ¹æ“šé—œéµå­—éæ¿¾ä¸‹æ‹‰é¸å–®
    function filterStudents(selectId, keyword) {
        const select = document.getElementById(selectId);
        const currentVal = select.value;
        
        let filtered = allStudentData;
        if (keyword) {
            const k = keyword.toLowerCase();
            filtered = allStudentData.filter(s => s.label.toLowerCase().includes(k));
        }

        let optionsHtml = `<option value="">${filtered.length === 0 ? '-- ç„¡ç¬¦åˆæœå°‹çµæœ --' : '-- è«‹é¸æ“‡å­¸ç”Ÿ --'}</option>`;
        filtered.forEach(stu => {
            optionsHtml += `<option value="${stu.value}">${stu.label}</option>`;
        });

        select.innerHTML = optionsHtml;
        
        // å¦‚æœåŸæœ¬é¸çš„å€¼é‚„åœ¨åˆ—è¡¨å…§ï¼Œä¿æŒé¸å–
        if (!keyword && currentVal) {
            select.value = currentVal;
        }
    }

    async function initStudentList() {
        const cloudSelect = document.getElementById('cloud-user');
        const aiSelect = document.getElementById('ai-name');
        
        const success = await loadDB('student');
        
        if (!success) {
            const errOption = `<option value="">è®€å–å¤±æ•— (è«‹æª¢æŸ¥é€£çµ)</option>`;
            cloudSelect.innerHTML = errOption;
            aiSelect.innerHTML = errOption;
            return;
        }

        if (studentDB.length === 0) {
            const emptyOption = `<option value="">ç„¡å­¸ç”Ÿè³‡æ–™</option>`;
            cloudSelect.innerHTML = emptyOption;
            aiSelect.innerHTML = emptyOption;
            return;
        }

        const firstRow = studentDB[0];
        const keyUser = findKey(firstRow, POSSIBLE_USER_KEYS); 
        const keyName = findKey(firstRow, POSSIBLE_NAME_KEYS); 

        let uniqueStudents = new Map();

        studentDB.forEach(row => {
            const id = row[keyUser] ? row[keyUser].toString().trim() : '';
            const name = keyName && row[keyName] ? row[keyName].toString().trim() : '';
            const key = id || name;
            
            if (key && !uniqueStudents.has(key)) {
                let label = name;
                if (id && name && id !== name) label = `[${id}] ${name}`;
                else if (id) label = id;
                uniqueStudents.set(key, { value: id || name, label: label });
            }
        });

        // å­˜å…¥å…¨åŸŸè®Šæ•¸
        allStudentData = Array.from(uniqueStudents.values()).sort((a, b) => a.label.localeCompare(b.label, 'zh-Hant'));
        
        // åˆå§‹æ¸²æŸ“
        filterStudents('cloud-user', '');
        filterStudents('ai-name', '');
        
        console.log(`æˆåŠŸè¼‰å…¥ ${allStudentData.length} ä½å­¸ç”Ÿ`);
    }

    async function autoLoadCombatPower() {
        const inputUser = document.getElementById('ai-name').value.trim();
        if (!inputUser) { showStatus('è«‹å…ˆé¸æ“‡å­¸ç”Ÿ', 'error'); return; }
        if (!(await loadDB('student'))) return;
        showStatus(`æ­£åœ¨èˆ‡æŒ‡æ®éƒ¨è³‡æ–™åº«åŒæ­¥...`, 'ai');
        
        const firstRow = studentDB[0];
        const keyUser = findKey(firstRow, POSSIBLE_USER_KEYS);
        const keyName = findKey(firstRow, POSSIBLE_NAME_KEYS);
        let foundTopicKey = Object.keys(firstRow).find(k => k.includes('å–®å…ƒ') || k.includes('topic'));
        const keyScore = findKey(firstRow, POSSIBLE_SCORE_KEYS);
        const keyWrong = findKey(firstRow, POSSIBLE_ERROR_KEYS);
        const keyTotal = findKey(firstRow, ['ç¸½é¡Œæ•¸', 'total', 'count']);
        const keyCorrect = findKey(firstRow, ['ç­”å°', 'correct']);

        let statsMap = {}; 
        let foundUser = false;

        for (let i = 0; i < studentDB.length; i++) {
            const row = studentDB[i];
            const rowUser = row[keyUser] ? row[keyUser].toString().trim() : '';
            const rowName = keyName && row[keyName] ? row[keyName].toString().trim() : '';
            
            if (rowUser.toLowerCase() === inputUser.toLowerCase() || rowName === inputUser) {
                foundUser = true;
                let topic = row[foundTopicKey] || row['å–®å…ƒåç¨±'] || row['Topic'] || 'æœªçŸ¥å–®å…ƒ';
                
                // æ™‚é–“è™•ç†
                let timeRaw = row['æ™‚é–“æˆ³è¨˜'] || row['time'] || row['date'] || '2023/1/1';
                let timeVal = new Date(timeRaw).getTime();
                
                // åˆ†æ•¸/æ­£ç¢ºç‡è¨ˆç®— (èˆ‡æŒ‡æ®éƒ¨é‚è¼¯åŒæ­¥)
                let correct = parseInt(row[keyCorrect] || 0);
                let total = parseInt(row[keyTotal] || 1);
                let currentScore = 0;

                // å„ªå…ˆä½¿ç”¨ç®—å‡ºä¾†çš„æ­£ç¢ºç‡
                if (!isNaN(correct) && !isNaN(total) && total > 0) {
                    currentScore = Math.round((correct / total) * 100);
                } else {
                    // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥è®€å–åˆ†æ•¸æ¬„ä½
                    let scoreRaw = row[keyScore];
                    if (scoreRaw && !isNaN(parseFloat(scoreRaw))) { 
                        currentScore = parseFloat(scoreRaw); 
                        if (scoreRaw.includes('%')) currentScore *= 100; 
                        if (currentScore <= 1) currentScore = Math.round(currentScore * 100); 
                    }
                }

                // èšåˆæ•¸æ“š
                if (!statsMap[topic]) {
                    statsMap[topic] = { 
                        lastDate: 0, 
                        lastScore: 0,
                        totalQuestions: 0,
                        totalCorrect: 0
                    };
                }

                // æŒ‡æ®éƒ¨é‚è¼¯ï¼šåŒä¸€å–®å…ƒä»¥ã€Œæœ€æ–°æ—¥æœŸã€çš„æˆç¸¾ç‚ºæº– (å³æ™‚æˆ°åŠ›)
                // é€™è£¡æˆ‘å€‘é‡å°æ¯å€‹å–®å…ƒï¼ŒæŠŠæ‰€æœ‰ç´€éŒ„åˆ†é¡æ”¶é›†
                if (!statsMap[topic].records) statsMap[topic].records = [];
                statsMap[topic].records.push({ date: timeVal, score: currentScore, correct: correct, total: total });
            }
        }

        if (!foundUser) { showStatus(`âŒ æ‰¾ä¸åˆ°è³‡æ–™`, 'error'); return; }

        let outputText = ""; 
        const sortedTopics = Object.keys(statsMap).sort();

        sortedTopics.forEach(topic => {
            const data = statsMap[topic];
            // ä¾æ™‚é–“é™åºæ’åˆ— (æœ€æ–°çš„åœ¨å‰é¢)
            data.records.sort((a,b) => b.date - a.date);
            
            // æŒ‡æ®éƒ¨æ ¸å¿ƒé‚è¼¯ï¼šå–ã€Œæœ€è¿‘ä¸€æ¬¡ã€çš„æˆç¸¾ä½œç‚ºæˆ°åŠ›å€¼
            // é€™ä»£è¡¨è©²ç”Ÿç›®å‰çš„ç¨‹åº¦
            if (data.records.length > 0) {
                let latestRec = data.records[0];
                
                // V9.2 æ”¹å‹•ï¼šä¸å†ä½¿ç”¨åŠ æ¬Šå¹³å‡ï¼Œç›´æ¥ä½¿ç”¨æœ€æ–°ä¸€æ¬¡çš„æˆç¸¾
                // é€™èƒ½ç¢ºä¿èˆ‡æŒ‡æ®éƒ¨çœ‹åˆ°çš„ç¶ è‰²/ç´…è‰²ç‡ˆè™Ÿä¸€è‡´
                let finalScore = latestRec.score;
                outputText += `${topic} ${finalScore}\n`;
            }
        });

        if (outputText) { 
            document.getElementById('ai-data').value = outputText; 
            showStatus(`âœ… æˆ°åŠ›åŒæ­¥å®Œæˆï¼(ä¾æ“šæœ€æ–°æ¸¬é©—æˆç¸¾)`, 'ai'); 
        } else { 
            showStatus(`âš ï¸ ç„¡æœ‰æ•ˆæ¸¬é©—è³‡æ–™ã€‚`, 'error'); 
        }
    }

    async function generateFromAI() {
        const nameText = document.getElementById('ai-name').options[document.getElementById('ai-name').selectedIndex].text;
        const name = nameText.includes('è«‹é¸æ“‡') ? 'å­¸ç”Ÿ' : nameText.split(']')[1] || nameText; 
        
        const rawData = document.getElementById('ai-data').value.trim();
        if (!rawData) { showStatus('è«‹è¼¸å…¥æˆ°åŠ›åˆ†ææ•¸æ“š', 'error'); return; }
        if (!(await loadDB('question'))) return;
        const lines = rawData.split('\n'); let topics = [];
        lines.forEach(line => {
            let parts = line.split(/[:ï¼š\s]+/);
            if (parts.length >= 2) { let scoreStr = parts[parts.length - 1]; let score = parseInt(scoreStr); if (!isNaN(score)) { let topic = line.substring(0, line.lastIndexOf(scoreStr)).trim(); if (topic.endsWith(':') || topic.endsWith('ï¼š')) topic = topic.slice(0, -1); if (topic) topics.push({ topic, score }); } }
        });
        if (topics.length === 0) { showStatus('æ•¸æ“šæ ¼å¼éŒ¯èª¤', 'error'); return; }
        let totalWeight = 0; topics.forEach(t => { t.weight = Math.max(5, 100 - t.score); totalWeight += t.weight; });
        const TOTAL_SLOTS = 10; let finalIds = []; let distributionLog = [];
        topics.forEach(t => { let count = Math.round((t.weight / totalWeight) * TOTAL_SLOTS); if (count < 1 && t.score < 60) count = 1; t.allocCount = count; });
        let currentTotal = topics.reduce((sum, t) => sum + t.allocCount, 0); topics.sort((a,b) => a.score - b.score);
        while (currentTotal > TOTAL_SLOTS) { for (let i = topics.length - 1; i >= 0; i--) { if (topics[i].allocCount > 0) { topics[i].allocCount--; currentTotal--; if (currentTotal === TOTAL_SLOTS) break; } } }
        while (currentTotal < TOTAL_SLOTS) { topics[0].allocCount++; currentTotal++; }
        topics.forEach(t => {
            if (t.allocCount > 0) {
                const targetTopicNormalized = normalizeText(t.topic);
                const candidates = questionDB.filter(q => { const dbTopic = q[COL_Q_TOPIC]; if (!dbTopic) return false; const dbTopicNormalized = normalizeText(dbTopic); return dbTopicNormalized.includes(targetTopicNormalized) || targetTopicNormalized.includes(dbTopicNormalized); });
                if (candidates.length > 0) { for (let i = 0; i < t.allocCount; i++) { const randQ = candidates[Math.floor(Math.random() * candidates.length)]; finalIds.push(randQ[COL_Q_ID]); } distributionLog.push(`${t.topic} â” ${t.allocCount}é¡Œ`); } else { distributionLog.push(`(ç•¥é) ${t.topic}`); }
            }
        });
        if (finalIds.length > 0) { showStatus(`ğŸ¤– AI åˆ†é…ï¼š\n${distributionLog.join('\n')}`, 'ai'); buildBook(name, finalIds, '(AI å¼±é»æ“Šç ´æ¨¡å¼)', true); } else { showStatus('ç„¡æ³•ç”Ÿæˆé¡Œç›®', 'error'); }
    }

    async function generateFromCloud() {
        const inputUser = document.getElementById('cloud-user').value.trim();
        const nameText = document.getElementById('cloud-user').options[document.getElementById('cloud-user').selectedIndex].text;
        const displayName = nameText.includes('[') ? (nameText.split(']')[1] || nameText).trim() : nameText;

        if (!inputUser) { showStatus('è«‹é¸æ“‡å­¸ç”Ÿ', 'error'); return; }
        if (!(await loadDB('question'))) return;
        if (!(await loadDB('student'))) return;

        showStatus(`æ­£åœ¨åˆ†æ ${displayName}...`);
        const firstRow = studentDB[0];
        const keyUser = findKey(firstRow, POSSIBLE_USER_KEYS);
        const keyError = findKey(firstRow, POSSIBLE_ERROR_KEYS);
        const keyName = findKey(firstRow, POSSIBLE_NAME_KEYS);

        if (!keyUser || !keyError) { showStatus(`âŒ æ¬„ä½å°æ‡‰å¤±æ•—ï¼`, 'error'); return; }

        let rawErrors = []; 
        studentErrorMap = {}; 

        for (let i = studentDB.length - 1; i >= 0; i--) {
            const row = studentDB[i];
            const rowUser = row[keyUser] ? row[keyUser].toString().trim() : '';
            const rowName = keyName && row[keyName] ? row[keyName].toString().trim() : '';
            
            if (rowUser.toLowerCase() === inputUser.toLowerCase() || rowName === inputUser) {
                const errString = row[keyError];
                if (errString && (errString.startsWith('[') || errString.startsWith('{'))) {
                    try {
                        const errs = JSON.parse(errString);
                        if (Array.isArray(errs)) {
                            errs.forEach(e => {
                                if (e.quizId) {
                                    let errTime = new Date();
                                    if(e.time) { const datePart = e.time.split(' ')[0]; errTime = new Date(datePart); }
                                    rawErrors.push({ id: e.quizId, time: errTime });
                                    studentErrorMap[e.quizId] = { wrong: e.wrong, correct: e.correct };
                                }
                            });
                        }
                    } catch (e) { }
                }
            }
        }

        if (rawErrors.length === 0) { showStatus(`âš ï¸ ç„¡éŒ¯é¡Œç´€éŒ„`, 'error'); return; }

        const startDateStr = document.getElementById('date-start').value;
        const endDateStr = document.getElementById('date-end').value;
        const limit = parseInt(document.getElementById('q-limit').value) || 20;
        let startDate = startDateStr ? new Date(startDateStr) : new Date('2000-01-01');
        let endDate = endDateStr ? new Date(endDateStr) : new Date();
        endDate.setHours(23, 59, 59, 999); 

        let filteredErrors = rawErrors.filter(e => {
            if(isNaN(e.time.getTime())) return true;
            return e.time >= startDate && e.time <= endDate;
        });
        let uniqueIds = [...new Set(filteredErrors.map(e => e.id))];
        if (uniqueIds.length > limit) uniqueIds = uniqueIds.slice(0, limit); 
        if (uniqueIds.length === 0) { showStatus(`ç¯„åœå…§ç„¡éŒ¯é¡Œ`, 'error'); return; }

        buildBook(displayName, uniqueIds, `(ç¯©é¸ç¯„åœ: è¿‘ ${uniqueIds.length} é¡Œ)`, false);
    }

    async function generateFromManual() {
        const name = document.getElementById('manual-name').value.trim() || 'å­¸ç”Ÿ';
        const idsStr = document.getElementById('manual-ids').value.trim();
        if (!idsStr) { showStatus('è«‹è¼¸å…¥é¡Œè™Ÿ', 'error'); return; }
        if (!(await loadDB('question'))) return;
        const ids = idsStr.replace(/ï¼Œ/g, ',').split(',').map(s => s.trim()).filter(s => s);
        buildBook(name, ids, '', false);
    }

    function buildBook(name, ids, subTitle, isAIMode = false) {
        const container = document.getElementById('book-container');
        container.innerHTML = '';
        
        let pageDiv = createPage(name, subTitle);
        let count = 0;
        let validCount = 0;

        // V7.1 æ”¶é›† ID ç”¨
        let listOriginal = [];
        let listSimilar = [];

        for (let qId of ids) {
            const targetId = qId.toString().trim();
            const originalQ = questionDB.find(r => r[COL_Q_ID] && r[COL_Q_ID].toString().trim() === targetId);
            if (!originalQ) continue;
            validCount++;
            
            // è¨˜éŒ„åŸå§‹éŒ¯é¡ŒID
            listOriginal.push(originalQ[COL_Q_ID]);

            const category = originalQ[COL_Q_CAT];
            const topic = originalQ[COL_Q_TOPIC];
            let candidates = [];
            if (category) candidates = questionDB.filter(r => r[COL_Q_CAT] == category && r[COL_Q_ID].toString().trim() !== targetId);
            if (candidates.length === 0) candidates = questionDB.filter(r => r[COL_Q_TOPIC] == topic && r[COL_Q_ID].toString().trim() !== targetId);
            const similarQ = candidates.length > 0 ? candidates[Math.floor(Math.random() * candidates.length)] : null;

            // è¨˜éŒ„é¡é¡ŒID (è‹¥æœ‰æ‰¾åˆ°)
            if (similarQ) {
                listSimilar.push(similarQ[COL_Q_ID]);
            }

            if (count > 0 && count % 3 === 0) {
                container.appendChild(pageDiv);
                pageDiv = createPage(name, subTitle);
            }

            const leftLabel = isAIMode ? `<span class="q-label ai-weakness">å¼±é»æ“Šç ´ (ID: ${originalQ[COL_Q_ID]})</span>` : `<span class="q-label original">éŒ¯é¡Œé‡ç·´ (ID: ${originalQ[COL_Q_ID]})</span>`;
            const rightLabel = isAIMode ? `<span class="q-label similar">é¡é¡Œéå›º ${similarQ ? `(ID: ${similarQ[COL_Q_ID]})` : ''}</span>` : `<span class="q-label similar">é¡é¡Œå¼·åŒ– ${similarQ ? `(ID: ${similarQ[COL_Q_ID]})` : '(ç¨å®¶)'}</span>`;

            let ans1 = originalQ[COL_Q_ANS] || '';
            let ans2 = similarQ ? (similarQ[COL_Q_ANS] || '') : '';
            let studentErrInfo = "";
            if (studentErrorMap[targetId]) {
                const err = studentErrorMap[targetId];
                if (err.wrong) studentErrInfo = ` (èª¤é¸: ${err.wrong})`;
                if (!ans1 && err.correct) ans1 = err.correct;
            }

            const leftAnsHtml = `<div class="ans-box">æ­£ç¢ºè§£ç­”ï¼š${ans1 || 'ç„¡'}${studentErrInfo}</div>`;
            const rightAnsHtml = similarQ ? `<div class="ans-box right-col">åƒè€ƒè§£ç­”ï¼š${ans2 || 'ç„¡'}</div>` : '';

            const rowHtml = `
                <div class="question-row">
                    <div class="q-col" style="border-right: 1px dotted #ccc; padding-right: 15px;">
                        ${leftLabel}
                        <div class="q-content">
                            <div>${originalQ[COL_Q_TOPIC]}</div>
                            ${renderMedia(originalQ[COL_Q_IMG])}
                        </div>
                        ${leftAnsHtml}
                        <div class="qr-area">
                            <div id="qr-l-${validCount}"></div>
                            <div class="qr-text">æƒæçœ‹è©³è§£<br>å½±ç‰‡æ•™å­¸</div>
                        </div>
                    </div>
                    <div class="q-col" style="padding-left: 15px;">
                        ${rightLabel}
                        ${similarQ ? `
                            <div class="q-content">
                                <div>${similarQ[COL_Q_TOPIC]}</div>
                                ${renderMedia(similarQ[COL_Q_IMG])}
                            </div>
                            ${rightAnsHtml}
                            <div class="qr-area">
                                <div id="qr-r-${validCount}"></div>
                                <div class="qr-text">ä¸æœƒåšï¼Ÿ<br>çœ‹é€™é¡Œè¬›è§£</div>
                            </div>
                        ` : '<div style="color:#999; margin-top:20px;">æ­¤é¡Œå‹æš«ç„¡é¡é¡Œï¼Œè«‹å°ˆæ³¨è¨‚æ­£å·¦å´é¡Œç›®ã€‚</div>'}
                    </div>
                </div>
            `;
            const div = document.createElement('div');
            div.innerHTML = rowHtml;
            pageDiv.appendChild(div);

            (function(idx, q1, q2) {
                setTimeout(() => {
                    if (q1[COL_Q_VIDEO]) generateQR(`qr-l-${idx}`, q1[COL_Q_VIDEO]);
                    if (q2 && q2[COL_Q_VIDEO]) generateQR(`qr-r-${idx}`, q2[COL_Q_VIDEO]);
                }, 100);
            })(validCount, originalQ, similarQ);
            count++;
        }
        container.appendChild(pageDiv);
        
        if (validCount > 0) {
            // V7.1 å¡«å…¥ ID
            document.getElementById('export-original').value = listOriginal.join(', ');
            document.getElementById('export-similar').value = listSimilar.join(', ');

            const cmdBar = document.getElementById('command-bar');
            cmdBar.style.display = 'block'; // æ”¹å› block è®“å…§éƒ¨ flex ç”Ÿæ•ˆ
            cmdBar.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setRole('teacher'); 
        }
    }

    function createPage(name, sub) {
        const d = document.createElement('div');
        d.className = 'page';
        d.innerHTML = `<div class="book-header"><h2 class="book-title">${name} çš„å°ˆå±¬è¬›ç¾©</h2><div class="book-sub">DayDayè€å¸« â€¢ æ•¸æ“šé©…å‹•æ•™å­¸ â€¢ ${new Date().toLocaleDateString()} ${sub}</div></div>`;
        return d;
    }
    function renderMedia(url) {
        if (!url || url.length < 5) return '<p>[è«‹åƒé–±æ–‡å­—æ•˜è¿°]</p>';
        return `<img src="${url}" class="q-img">`;
    }
    function generateQR(id, url) {
        const el = document.getElementById(id);
        if (el) { el.innerHTML = ''; new QRCode(el, { text: url, width: 60, height: 60, correctLevel: QRCode.CorrectLevel.L }); }
    }

    function copyToClip(elementId) {
        const copyText = document.getElementById(elementId);
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value).then(() => {
            const btn = document.querySelector(`button[onclick="copyToClip('${elementId}')"]`);
            btn.innerText = "å·²è¤‡è£½!";
            btn.style.background = "#166534";
            btn.style.color = "#fff";
            setTimeout(() => {
                btn.innerText = "è¤‡è£½";
                btn.style.background = "";
                btn.style.color = "";
            }, 1500);
        });
    }

    // ----------------------------------------------------
    // DayDay éŒ¯é¡Œæ¶ˆæ»…ç³»çµ± V9.0 - é›²ç«¯æ•´åˆæ¥å£
    // ----------------------------------------------------
    function generateOnlineQuiz() {
        // 1. å–å¾—å­¸ç”Ÿè³‡æ–™ (æ”¯æ´ [ID] å§“å æ ¼å¼)
        const cloudSel = document.getElementById('cloud-user');
        const aiSel = document.getElementById('ai-name');
        const manualName = document.getElementById('manual-name').value;
        
        let studentName = "";
        
        // åˆ¤æ–·ç›®å‰åœ¨å“ªå€‹æ¨¡å¼
        if (document.getElementById('mode-cloud').classList.contains('active')) {
            studentName = cloudSel.options[cloudSel.selectedIndex]?.text;
        } else if (document.getElementById('mode-ai').classList.contains('active')) {
            studentName = aiSel.options[aiSel.selectedIndex]?.text;
        } else {
            studentName = manualName;
        }
        
        if (!studentName || studentName.includes("è«‹é¸æ“‡")) studentName = "æœªçŸ¥å­¸ç”Ÿ";

        // 2. å–å¾—é¡Œç›® ID
        const source = document.getElementById('quiz-source').value;
        let ids = (source === 'similar') ? document.getElementById('export-similar').value : document.getElementById('export-original').value;

        if (!ids) {
            alert("âŒ éŒ¯èª¤ï¼šæ²’æœ‰é¡Œè™Ÿï¼\nè«‹å…ˆæŒ‰ä¸‹ã€Œæœå°‹éŒ¯é¡Œã€æˆ–ã€ŒAI çµ„å·ã€ç”¢ç”Ÿé¡Œç›®ã€‚");
            return;
        }

        // 3. æº–å‚™ç™¼é€è³‡æ–™
        const taskCode = Math.floor(1000 + Math.random() * 9000); // ç”¢ç”Ÿ 4 ç¢¼ä»£ç¢¼
        const linkArea = document.getElementById('quiz-link');
        
        // UI é¡¯ç¤ºè®€å–ä¸­
        linkArea.style.display = "block";
        linkArea.style.background = "#fff";
        linkArea.style.padding = "10px";
        linkArea.style.border = "1px solid #ccc";
        linkArea.style.marginTop = "10px";
        linkArea.innerHTML = `<div>â³ æ­£åœ¨å°‡è©¦å·ä¸Šå‚³é›²ç«¯... (ä»£ç¢¼: ${taskCode})</div>`;

        // 4. ç™¼é€è«‹æ±‚çµ¦ GAS (è§£æ±º CORS çš„é—œéµé…ç½®)
        fetch(GAS_EXAM_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // é¿é–‹é æª¢è«‹æ±‚
            redirect: 'follow',
            body: JSON.stringify({ 
                type: 'register_code', 
                code: taskCode, 
                student: studentName,
                ids: ids 
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                // å»ºæ§‹è€ƒå·ç¶²å€ï¼š GASç¶²å€ + ?op=take_quiz&code=ä»£ç¢¼
                const quizUrl = `${GAS_EXAM_URL}?op=take_quiz&code=${taskCode}`;
                
                linkArea.style.background = "#f0fdf4";
                linkArea.style.border = "1px solid #166534";
                linkArea.innerHTML = `
                    <div style="color:#166534; font-weight:bold; margin-bottom:5px;">âœ… é›²ç«¯è©¦å·å»ºç«‹æˆåŠŸï¼</div>
                    <div style="font-size:0.95rem; color:#333;">
                        ä»»å‹™ä»£ç¢¼ï¼š<b style="color:#d97706; font-size:1.3rem;">${taskCode}</b>
                    </div>
                    <div style="margin-top:8px;">
                        <a href="${quizUrl}" target="_blank" style="background:#0ea5e9; color:white; padding:8px 15px; text-decoration:none; border-radius:4px; font-weight:bold; display:inline-block;">ğŸ‘‰ é–‹å•Ÿç·šä¸Šæ¸¬é©—</a>
                    </div>
                `;
            } else {
                throw new Error(data.msg);
            }
        })
        .catch(err => {
            console.error(err);
            linkArea.style.background = "#fef2f2";
            linkArea.style.border = "1px solid #ef4444";
            linkArea.innerHTML = `<div style="color:#991b1b;">âŒ é€£ç·šå¤±æ•—ï¼š${err.message}</div><div style="font-size:0.8rem;">è«‹æª¢æŸ¥ GAS ç¶²å€æˆ–ç¶²è·¯ç‹€æ…‹ã€‚</div>`;
        });
    }
</script>
</body>
</html>